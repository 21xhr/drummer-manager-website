<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:,">
    
    <title>Explorer | Drummer Manager</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <link rel="stylesheet" href="../css/global.css">
    <link rel="stylesheet" href="../css/explorer.css">

    <script src="/js/social-links.js" defer></script>
</head>
<body>

    <div id="lockScreen" class="lock-overlay">
        <div class="form-container terminal-card">
            <i id="statusIcon" class="fa-solid fa-spinner fa-spin status-icon-main neon-text"></i>
            <h2 class="neon-text">SYSTEM ENCRYPTED</h2>
            <div id="statusMessage1" class="roboto status-msg-text">
                Verifying secure link...
            </div>
        </div>
    </div>

    <div class="explorer-app-container">
        <header class="explorer-header">
            <div class="brand-group">
                <div class="brand-title neon-text">DRUMMER</div>
                <div class="brand-subtitle roboto">MANAGER</div>
            </div>
            
            <div class="header-status-column"> 
                <div class="status-indicator-row">
                    <button type="button" id="muteToggle" class="mute-btn">
                        <i id="muteIcon" class="fa-solid fa-volume-high"></i>
                    </button>
                    <span id="streamStatusText" class="roboto stream-text">OFFLINE</span>
                    <div id="streamStatusIndicator" class="stream-status-indicator offline"></div>
                </div>
                
                <div id="identityReminder" class="hidden">
                    <div class="identity-flex">
                        <span id="reminderUsername" class="roboto user-label"></span>
                        <div id="platformContainer" class="roboto platform-label">
                            on <span id="reminderPlatform" class="font-bold"></span>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <div class="explorer-content-grid">
            <aside class="explorer-sidebar" id="filterPane">
                <button class="pane-toggle" onclick="togglePane('filterPane', event)"><i class="fa-solid fa-chevron-left"></i></button>
                <div class="pane-content">
                    <h3 class="neon-text filter-pane-title">SYSTEM FILTERS</h3>
                    
                    <div class="filter-group">
                        <label class="label-accent">DAYS ACTIVE</label>
                        <div class="range-wrapper">
                            <div class="dual-range-container">
                                <div class="range-track"></div>
                                <div id="rangeHighlight" class="range-highlight"></div>
                                <input type="range" id="minDays" min="0" max="21" value="0" class="range-input">
                                <input type="range" id="maxDays" min="0" max="21" value="21" class="range-input">
                            </div>
                            <div class="range-inputs-row">
                                <input type="number" id="minDaysInput" value="0" min="0" max="21" class="small-num-input">
                                <span class="range-to-label roboto">TO</span>
                                <input type="number" id="maxDaysInput" value="21" min="0" max="21" class="small-num-input">
                            </div>
                        </div>
                    </div>

                    <div class="filter-group">
                        <label class="label-accent">CHALLENGE STATUS</label>
                        <div id="statusFilters" class="status-filter-stack">
                            <div class="status-item active" onclick="toggleStatusFilter(this, 'PENDING')">PENDING</div>
                            <div class="status-item active" onclick="toggleStatusFilter(this, 'ACTIVE')">ACTIVE</div>
                            <div class="status-item active" onclick="toggleStatusFilter(this, 'IN_PROGRESS')">IN_PROGRESS</div>
                            <div class="status-item active" onclick="toggleStatusFilter(this, 'COMPLETED')">COMPLETED</div>
                            <div class="status-item active" onclick="toggleStatusFilter(this, 'FAILED')">FAILED</div>
                            <div class="status-item active" onclick="toggleStatusFilter(this, 'ARCHIVED')">ARCHIVED</div>
                            <div class="status-item active" onclick="toggleStatusFilter(this, 'AUCTIONED')">AUCTIONED</div>
                            <div class="status-item active" onclick="toggleStatusFilter(this, 'REMOVED')">REMOVED</div>
                        </div>
                    </div>

                    <div class="filter-group">
                        <label class="label-accent">PUSH THRESHOLD</label>
                        <input type="number" id="minPushFilter" placeholder="MIN" class="filter-input-round push-filter-input">
                    </div>
                </div>
            </aside>

            <main class="explorer-main">
                <div class="list-controls">
                    <div class="search-bar-wrapper">
                        <span class="neon-text search-prompt">></span>
                        <input type="text" id="globalSearch" class="filter-input-round" placeholder="SEARCH DATABASE...">
                    </div>
                    <div id="syncTimer" class="sync-status">SYNCING</div>
                </div>

                <div id="challengeList">
                    <div class="list-header">
                        <span>ID</span>
                        <span>STATUS</span>
                        <span>PROPOSER</span>
                        <span>DESCRIPTION</span>
                        <span>PUSHES</span>
                    </div>
                    <div id="listEntries"></div>
                </div>
            </main>

            <aside class="explorer-sidebar collapsed" id="detailPane">
                <button class="pane-toggle" onclick="togglePane('detailPane')"><i class="fa-solid fa-chevron-right"></i></button>
                <div class="pane-content">
                    <div id="detailContent" class="hidden"></div>
                </div>
            </aside>
        </div>
    </div>

    <social-links></social-links>
</body>
<script>
    let allChallenges = [];
    let lastSyncTimestamp = new Date().toISOString();
    // Tracking active status filters based on Prisma schema
    let activeStatusFilters = ['PENDING', 'ACTIVE', 'IN_PROGRESS', 'COMPLETED', 'FAILED', 'ARCHIVED', 'AUCTIONED', 'REMOVED'];

    const IS_DEV = true; 
    const TYPE_PAUSE = IS_DEV ? 10 : 420;

    const getApiBaseUrl = () => {
        const hostname = window.location.hostname;
        if (hostname === 'localhost' || hostname === '127.0.0.1' || hostname === '0.0.0.0') {
            return 'http://127.0.0.1:3000/api/v1'; 
        }
        if (hostname.startsWith('192.168.')) {
            return `http://${hostname}:3000/api/v1`; 
        }
        return 'https://drummer-manager-api.vercel.app/api/v1';
    };
    const API_BASE_URL = getApiBaseUrl();

    const minDaysRange = document.getElementById('minDays');
    const maxDaysRange = document.getElementById('maxDays');
    const minDaysInput = document.getElementById('minDaysInput');
    const maxDaysInput = document.getElementById('maxDaysInput');
    const rangeHighlight = document.getElementById('rangeHighlight');

    function syncRange() {
        let minVal = parseInt(minDaysRange.value);
        let maxVal = parseInt(maxDaysRange.value);

        if (minVal > maxVal) {
            let temp = minVal;
            minVal = maxVal;
            maxVal = temp;
        }

        minDaysInput.value = minVal;
        maxDaysInput.value = maxVal;

        const left = (minVal / 21) * 100;
        const right = 100 - (maxVal / 21) * 100;
        rangeHighlight.style.left = left + "%";
        rangeHighlight.style.right = right + "%";
        
        applyFilters();
    }

    // Toggle logic for the Status Filter stack
    function toggleStatusFilter(element, status) {
        element.classList.toggle('active');
        if (activeStatusFilters.includes(status)) {
            activeStatusFilters = activeStatusFilters.filter(s => s !== status);
        } else {
            activeStatusFilters.push(status);
        }
        applyFilters();
    }

    [minDaysRange, maxDaysRange].forEach(el => el.addEventListener('input', syncRange));
    [minDaysInput, maxDaysInput].forEach(el => el.addEventListener('change', (e) => {
        if(e.target.id === 'minDaysInput') minDaysRange.value = e.target.value;
        else maxDaysRange.value = e.target.value;
        syncRange();
    }));

    const typeWriter = (element, text, n, callback) => {
        if (n < text.length) {
            const typoIndex = text.indexOf('@') - 1; 
            const hasTypoOccurred = element.getAttribute('data-typo') === 'true';

            let delay = IS_DEV ? 1 : (Math.floor(Math.random() * 63) + 42); 
            if (text.charAt(n) === ' ' || text.charAt(n) === ':') delay = IS_DEV ? 5 : 210;

            if (n === typoIndex && !hasTypoOccurred) {
                element.innerHTML = text.substring(0, n) + "q"; 
                element.setAttribute('data-typo', 'true');
                setTimeout(() => {
                    element.innerHTML = text.substring(0, n);
                    setTimeout(() => typeWriter(element, text, n, callback), TYPE_PAUSE); 
                }, IS_DEV ? 5 : 210);
                return;
            }

            element.innerHTML = text.substring(0, n + 1);
            n++;
            setTimeout(() => typeWriter(element, text, n, callback), delay);
        } else if (callback) {
            setTimeout(callback, TYPE_PAUSE);
        }
    };

    window.onload = () => {
        // Collapse filter pane by default on mobile devices
        if (window.innerWidth <= 768) {
            document.getElementById('filterPane').classList.add('collapsed');
        }
        fetchStreamStatus();
        syncRange();
        const urlParams = new URLSearchParams(window.location.search);
        const urlToken = urlParams.get('token');
        const savedToken = localStorage.getItem('explorer_token');
        const tokenToVerify = urlToken || savedToken;

        if (tokenToVerify) {
            verifyExplorerAccess(tokenToVerify);
        } else {
            showLockScreen("ACCESS DENIED<br><span style='font-size:11px'>Use !challengeexplorer in chat.</span>");
        }
    };

    function showLockScreen(msg) {
        document.getElementById('lockScreen').classList.remove('hidden');
        document.getElementById('statusMessage1').innerHTML = msg;
        document.getElementById('statusIcon').className = "fa-solid fa-lock status-icon-main neon-text";
    }

    const verifyExplorerAccess = async (token) => {
        const statusIcon = document.getElementById('statusIcon');
        const statusMessage1 = document.getElementById('statusMessage1');
        
        try {
            const response = await fetch(`${API_BASE_URL}/token/verify-explorer`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token })
            });
            const data = await response.json();

            if (response.ok) {
                const userSpan = document.getElementById('reminderUsername');
                const platSpan = document.getElementById('reminderPlatform');
                const platContainer = document.getElementById('platformContainer');
                
                userSpan.textContent = data.username;
                platSpan.textContent = data.platformName;
                
                const platClass = `platform-${data.platformName.toLowerCase()}`;
                userSpan.className = `roboto user-label ${platClass}`;
                platContainer.className = `roboto platform-label ${platClass}`;

                statusIcon.classList.remove('fa-spinner', 'fa-spin');
                statusIcon.classList.add('fa-circle-check', 'text-success-green');
                
                statusMessage1.innerHTML = `<div class="typewriter-container"><div id="typewriter" class="typewriter-cursor"></div></div>`;
                
                typeWriter(document.getElementById('typewriter'), `> ACCESS GRANTED: ${data.username} @ ${data.platformName}`, 0, () => {
                    document.getElementById('lockScreen').classList.add('hidden');
                    document.getElementById('identityReminder').classList.remove('hidden');
                    localStorage.setItem('explorer_token', token);
                    loadInitialData();
                    startPolling();
                });
            } else {
                statusIcon.classList.remove('fa-spinner', 'fa-spin');
                statusIcon.classList.add('fa-lock', 'text-red-500');
                statusMessage1.innerHTML = `ACCESS DENIED<br><span style='font-size:11px'>${data.message || 'Invalid Token'}</span>`;
            }
        } catch (err) {
            statusIcon.classList.remove('fa-spinner', 'fa-spin');
            statusIcon.classList.add('fa-triangle-exclamation', 'text-red-500');
            statusMessage1.innerHTML = "CONNECTION ERROR<br>System offline.";
        }
    };

    async function loadInitialData() {
        try {
            const res = await fetch(`${API_BASE_URL}/challenge`); 
            if (!res.ok) throw new Error("Database offline");
            allChallenges = await res.json();
            renderList(allChallenges);
        } catch (err) { console.error("Fetch error", err); }
    }

    function renderList(challenges) {
        const container = document.getElementById('listEntries');
        container.innerHTML = '';
        challenges.forEach(c => {
            const row = document.createElement('div');
            row.className = 'entry-row animate-fadeIn';
            const proposerName = c.proposer?.accounts?.[0]?.username || c.proposer?.username || 'Unknown';
            const textPreview = typeof c.challengeText === 'string' ? c.challengeText : 'Challenge Data';
            
            row.innerHTML = `
                <span class="neon-text">${c.challengeId}</span>
                <span class="status-badge status-${c.status.toLowerCase()}">${c.status}</span>
                <span class="font-bold">${proposerName}</span>
                <span class="text-dim text-xs">${textPreview.substring(0, 50)}...</span>
                <span class="neon-text text-center">${c.totalPush}</span>
            `;
            row.onclick = () => hydrateDetail(c);
            container.appendChild(row);
        });
    }

    async function startPolling() {
        setInterval(async () => {
            try {
                const response = await fetch(`${API_BASE_URL}/challenge/delta?since=${lastSyncTimestamp}`);
                if (!response.ok) return;
                
                const updates = await response.json();
                if (updates.length > 0) {
                    updates.forEach(updatedChallenge => {
                        const index = allChallenges.findIndex(c => c.challengeId === updatedChallenge.challengeId);
                        if (index !== -1) { allChallenges[index] = updatedChallenge; } 
                        else { allChallenges.unshift(updatedChallenge); }
                    });
                    applyFilters(); 
                    lastSyncTimestamp = new Date().toISOString();
                    
                    const syncTimer = document.getElementById('syncTimer');
                    syncTimer.textContent = "DATABASE UPDATED";
                    syncTimer.style.color = "var(--primary-neon)";
                    setTimeout(() => {
                        syncTimer.textContent = "SYNCING";
                        syncTimer.style.color = "";
                    }, 2000);
                }
            } catch (err) { console.warn("Poll failed", err); }
        }, 21000);
    }

    function hydrateDetail(c) {
        const detailPane = document.getElementById('detailPane');
        const content = document.getElementById('detailContent');
        
        // Reveal pane and content immediately
        detailPane.classList.remove('collapsed');
        content.classList.remove('hidden');
        
        const shareLink = `${window.location.origin}/explorer/index.html?id=${c.challengeId}`;
        const proposerName = c.proposer?.accounts?.[0]?.username || c.proposer?.username || 'Unknown';

        content.innerHTML = `
            <div class="details-header">
                <h3 class="neon-text details-title">CHALLENGE DETAILS</h3>
                <div class="details-id-sub roboto">ID: ${c.challengeId} | SEQ: ${new Date(c.timestampSubmitted).getTime()}</div>
            </div>
            <div class="challenge-data-grid">
                <div class="challenge-field"><label>Proposer</label><span>${proposerName}</span></div>
                <div class="challenge-field"><label>Status</label><span>${c.status}</span></div>
                <div class="challenge-field"><label>Cadence</label><span>${c.sessionCadenceText || 'ONE-OFF'}</span></div>
                <div class="challenge-field"><label>Pushes</label><span>${c.totalPush}</span></div>
            </div>
            <div class="challenge-text-box roboto">${c.challengeText}</div>
            <div class="challenge-field challenge-failure-field">
                <label>Failure Reason</label>
                <span class="failure-reason-val">${c.failureReason || 'NONE'}</span>
            </div>
            <button onclick="copyToClipboard('${shareLink}')" class="primary-submit-btn share-btn">
                <i class="fa-solid fa-share-nodes"></i> COPY DEEP LINK
            </button>
        `;

        // The "Landing" Scroll
        setTimeout(() => {
            detailPane.scrollIntoView({ 
                behavior: 'smooth', 
                inline: 'start' 
            });
        }, 420);
    }

    const applyFilters = () => {
        const search = document.getElementById('globalSearch').value.toLowerCase();
        const minPush = parseInt(document.getElementById('minPushFilter').value) || 0;
        const minD = parseInt(minDaysRange.value);
        const maxD = parseInt(maxDaysRange.value);

        const filtered = allChallenges.filter(c => {
            const days = c.streamDaysSinceActivation || 0;
            const dateMatch = days >= minD && days <= maxD;
            
            const statusMatch = activeStatusFilters.includes(c.status.toUpperCase());
            
            const proposerName = (c.proposer?.accounts?.[0]?.username || c.proposer?.username || '').toLowerCase();
            const textMatch = proposerName.includes(search) || 
                                c.challengeId.toString().includes(search) ||
                                String(c.challengeText).toLowerCase().includes(search);
            
            const pushMatch = c.totalPush >= minPush;
            
            return dateMatch && statusMatch && textMatch && pushMatch;
        });
        renderList(filtered);
    };

    function copyToClipboard(text) {
        navigator.clipboard.writeText(text);
        alert("Challenge Link Copied to Clipboard");
    }

    const fetchStreamStatus = async () => {
        try {
            const res = await fetch(`${API_BASE_URL}/stream/stats`);
            const data = await res.json();
            const indicator = document.getElementById('streamStatusIndicator');
            const text = document.getElementById('streamStatusText');
            indicator.className = `stream-status-indicator ${data.isStreamLive ? 'live' : 'offline'}`;
            text.textContent = data.isStreamLive ? 'LIVE' : 'OFFLINE';
        } catch (err) {}
    };

    function togglePane(id, event) { 
        if (event) event.stopPropagation();
        
        const pane = document.getElementById(id);
        // Force the toggle
        pane.classList.toggle('collapsed');

        // If we just OPENED the detail pane, we need to scroll to it
        if (id === 'detailPane' && !pane.classList.contains('collapsed')) {
            setTimeout(() => {
                pane.scrollIntoView({ 
                    behavior: 'smooth', 
                    inline: 'end', // Scroll to the right edge
                    block: 'nearest' 
                });
            }, 100);
        } 
        // If we CLOSED it, scroll back to the list
        else if (id === 'detailPane' && pane.classList.contains('collapsed')) {
            const mainList = document.querySelector('.explorer-main');
            mainList.scrollIntoView({ behavior: 'smooth', inline: 'start' });
        }
    }

    document.getElementById('globalSearch').addEventListener('input', applyFilters);
    document.getElementById('minPushFilter').addEventListener('input', applyFilters);
</script>
</html>