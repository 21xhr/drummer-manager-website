<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DMG | Command Center</title>
    <link rel="stylesheet" href="../styles.css">
</head>
<body class="admin-body">
    <div id="login-overlay">
        <form id="login-form" class="admin-card login-box" onsubmit="unlock(event)">
            
            <h3 class="neon-text dm-sans">ADMIN ACCESS</h3>
            
            <div id="login-feedback" class="admin-feedback"></div>
            
            <input type="password" id="admin-key-input" name="password" 
                class="admin-input" placeholder="••••••••••••" 
                autocomplete="current-password">
            
            <button type="submit" id="login-btn" class="interactive-button form-button">
                ESTABLISH CONNECTION
            </button>
            
        </form>
    </div>

    <div id="admin-content" style="display:none; width: 100%;">
    <h1 class="dm-sans neon-text" style="text-align: center; width: 100%; margin: 40px 0;">GAME STATE MONITOR</h1>
        <div class="admin-grid">
            <div class="admin-card">
                <h2>System Status</h2>
                <div class="data-row">
                    <span class="metric-label">Supabase</span>
                    <span id="db-status" class="status-up">--</span>
                </div>
                <div class="data-row">
                    <span class="metric-label">Upstash</span>
                    <span id="redis-status" class="status-up">--</span>
                </div>
            </div>
            
            <div class="admin-card">
                <h2>Operational Clocks</h2>
                <div class="data-row">
                    <span class="metric-label">Days Live</span>
                    <span id="real-day" class="admin-metric">0</span>
                </div>
                <div class="data-row">
                    <span class="metric-label">Stream Days</span>
                    <span id="stream-day" class="admin-metric">0</span>
                </div>
                <div class="data-row">
                    <span class="metric-label">Last Maintenance</span>
                    <span id="last-maint" class="data-value">--</span>
                </div>
            </div>

            <div class="admin-card">
                <h2>Global Economy</h2>
                <div class="data-row">
                    <span class="metric-label">Gross Spent</span>
                    <span id="gross-spent" class="data-value">0</span>
                </div>
                <div class="data-row">
                    <span class="metric-label">Total Refunded</span>
                    <span id="refunded" class="data-value" style="color: var(--error-red)">0</span>
                </div>
                <hr style="border: 0; border-top: 1px solid #333; margin: 10px 0;">
                <div class="data-row">
                    <span class="neon-text metric-label">Net Flow</span>
                    <span id="net-economy" class="admin-metric">0</span>
                </div>
            </div>

           <div class="admin-card">
                <h2>Asset Allocation</h2>
                <div class="data-row">
                    <span class="metric-label">Community Chest</span>
                    <span id="chest" class="admin-metric">0</span>
                </div>
                <div class="data-row">
                    <span class="metric-label">Pusher Pool</span>
                    <span id="pushers" class="admin-metric">0</span>
                </div>
                <hr style="border:0; border-top:1px dashed #444; margin:15px 0;">
                <div class="data-row">
                    <span class="metric-label">"Removals" Refunded</span>
                    <span id="volatility" class="data-value">0</span>
                </div>
            </div>
        </div>
    </div>

<script>
        const getApiBaseUrl = () => {
    const host = window.location.hostname;
    if (['localhost', '127.0.0.1', '0.0.0.0'].includes(host)) return 'http://127.0.0.1:3000/api/v1';
    return host.startsWith('192.168.') ? `http://${host}:3000/api/v1` : 'https://drummer-manager-api.vercel.app/api/v1';
};

const API_BASE_URL = getApiBaseUrl();
let refreshInterval = null;

/**
 * Handle Login
 */
function unlock(event) {
    if (event) event.preventDefault();
    const key = document.getElementById('admin-key-input').value;
    const feedback = document.getElementById('login-feedback');
    
    if (!key) return feedback.textContent = "KEY REQUIRED";
    
    sessionStorage.setItem('dmg_admin_key', key);
    updateDashboard();
}

/**
 * Fetch and Render Data
 */
async function updateDashboard() {
    const key = sessionStorage.getItem('dmg_admin_key');
    if (!key) return;

    try {
        const res = await fetch(`${API_BASE_URL}/admin/pulse`, {
            headers: { 'X-Admin-Secret': key }
        });

        if (res.status === 401) {
            document.getElementById('login-feedback').textContent = "INVALID SECRET";
            sessionStorage.removeItem('dmg_admin_key');
            return;
        }

        const data = await res.json();

        // Check if the API actually returned a success status
        if (data.status !== "OK") {
            document.getElementById('login-feedback').textContent = data.message || "API ERROR";
            return;
        }
        
        // Toggle UI visibility
        document.getElementById('login-overlay').classList.add('hidden');
        document.getElementById('admin-content').style.display = 'block';

        // Update DOM using the PulseResponse Contract
        const { systems, financials, maintenance } = data;

        // Health
        const db = document.getElementById('db-status');
        const rd = document.getElementById('redis-status');
        db.textContent = systems.supabase;
        db.className = systems.supabase === 'UP' ? 'status-up' : 'status-down';
        rd.textContent = systems.upstash;
        rd.className = systems.upstash === 'UP' ? 'status-up' : 'status-down';

        // Clocks
        document.getElementById('real-day').textContent = maintenance.realDay;
        document.getElementById('stream-day').textContent = maintenance.streamDay;

        // Handle the ISO Date
        const maintDisplay = document.getElementById('last-maint');
        if (maintenance.lastRun) {
            const dateObj = new Date(maintenance.lastRun);
            // Display in a clean, readable UTC format
            maintDisplay.textContent = dateObj.toISOString().replace('T', ' ').substring(0, 19) + ' UTC';
        } else {
            maintDisplay.textContent = "NEVER";
        }

        // Financials
        document.getElementById('gross-spent').textContent = Number(financials.grossSpent).toLocaleString();
        document.getElementById('refunded').textContent = Number(financials.refunded).toLocaleString();
        document.getElementById('net-economy').textContent = Number(financials.netEconomy).toLocaleString();

        // Asset Allocation
        document.getElementById('chest').textContent = Number(financials.communityChest).toLocaleString();
        document.getElementById('pushers').textContent = Number(financials.totalToPushers).toLocaleString();
        document.getElementById('volatility').textContent = Number(financials.totalCausedByRemovals).toLocaleString();

        // Start Auto-Refresh if not already running
        if (!refreshInterval) refreshInterval = setInterval(updateDashboard, 60000);

    } catch (err) {
        console.error("Dashboard Sync Error:", err);
        document.getElementById('login-feedback').textContent = "CONNECTION ERROR";
    }
}

// Initial Run
if (sessionStorage.getItem('dmg_admin_key')) {
    updateDashboard();
}
</script>
</body>
</html> 