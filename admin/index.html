<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DMG | Command Center</title>
>    <link rel="stylesheet" href="../styles.css">
</head>
<body class="admin-body">
    <div id="login-overlay">
        <form id="login-form" class="admin-card login-box" onsubmit="unlock(event)">
            
            <h3 class="neon-text dm-sans">ADMIN ACCESS</h3>
            
            <div id="login-feedback" class="admin-feedback"></div>
            
            <input type="password" id="admin-key-input" name="password" 
                class="admin-input" placeholder="••••••••••••" 
                autocomplete="current-password">
            
            <button type="submit" id="login-btn" class="interactive-button form-button">
                ESTABLISH CONNECTION
            </button>
            
        </form>
    </div>

    <div id="admin-content" style="display:none; width: 100%; max-width: 1200px;">
        <h1 class="dm-sans neon-text">COMMAND CENTER</h1>
        
        <div class="admin-grid">
            <div class="admin-card">
                <h3>System Health</h3>
                <p>Supabase: <span id="db-status">--</span></p>
                <p>Upstash: <span id="redis-status">--</span></p>
            </div>
            
            <div class="admin-card">
                <h3>Clock Status</h3>
                <p>Real Day: <span id="real-day" class="admin-metric">-</span></p>
                <p>Stream Day: <span id="stream-day" class="admin-metric">-</span></p>
            </div>
            
            <div class="admin-card">
                <h3>Financials</h3>
                <p>Community Chest: <span id="chest" class="admin-metric">0</span></p>
                <p>Pusher Pool: <span id="pushers" class="admin-metric">0</span></p>
            </div>
        </div>
    </div>

<script>
        const getApiBaseUrl = () => {
    const host = window.location.hostname;
    if (['localhost', '127.0.0.1', '0.0.0.0'].includes(host)) return 'http://127.0.0.1:3000/api/v1';
    return host.startsWith('192.168.') ? `http://${host}:3000/api/v1` : 'https://drummer-manager-api.vercel.app/api/v1';
};

const API_BASE_URL = getApiBaseUrl();
let refreshInterval = null;

/**
 * Handle Login
 */
function unlock(event) {
    if (event) event.preventDefault();
    const key = document.getElementById('admin-key-input').value;
    const feedback = document.getElementById('login-feedback');
    
    if (!key) return feedback.textContent = "KEY REQUIRED";
    
    sessionStorage.setItem('dmg_admin_key', key);
    updateDashboard();
}

/**
 * Fetch and Render Data
 */
async function updateDashboard() {
    const key = sessionStorage.getItem('dmg_admin_key');
    if (!key) return;

    try {
        const res = await fetch(`${API_BASE_URL}/admin/pulse`, {
            headers: { 'X-Admin-Secret': key }
        });

        if (res.status === 401) {
            document.getElementById('login-feedback').textContent = "INVALID SECRET";
            sessionStorage.removeItem('dmg_admin_key');
            return;
        }

        const data = await res.json();
        
        // Toggle UI visibility
        document.getElementById('login-overlay').classList.add('hidden');
        document.getElementById('admin-content').style.display = 'block';

        // Update DOM using the PulseResponse Contract
        const { systems, financials, maintenance } = data;

        // Health
        const db = document.getElementById('db-status');
        const rd = document.getElementById('redis-status');
        db.textContent = systems.supabase;
        db.className = systems.supabase === 'UP' ? 'status-up' : 'status-down';
        rd.textContent = systems.upstash;
        rd.className = systems.upstash === 'UP' ? 'status-up' : 'status-down';

        // Clocks
        document.getElementById('real-day').textContent = maintenance.realDay;
        document.getElementById('stream-day').textContent = maintenance.streamDay;

        // Money
        document.getElementById('chest').textContent = parseInt(financials.communityChest).toLocaleString();
        document.getElementById('pushers').textContent = parseInt(financials.totalToPushers).toLocaleString();

        // Start Auto-Refresh if not already running
        if (!refreshInterval) refreshInterval = setInterval(updateDashboard, 60000);

    } catch (err) {
        console.error("Dashboard Sync Error:", err);
        document.getElementById('login-feedback').textContent = "CONNECTION ERROR";
    }
}

// Initial Run
if (sessionStorage.getItem('dmg_admin_key')) {
    updateDashboard();
}
</script>
</body>
</html> 