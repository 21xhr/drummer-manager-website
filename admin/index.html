<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:,">

    <title>DMG | Command Center</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <link rel="stylesheet" href="../css/global.css">
    <link rel="stylesheet" href="../css/admin.css">
</head>
<body class="admin-body">
    <div id="login-overlay">
        <form id="login-form" class="admin-card login-box" onsubmit="unlock(event)">
            
            <h3 class="neon-text dm-sans">ADMIN ACCESS</h3>
            
            <div id="login-feedback" class="admin-feedback"></div>
            
            <input type="password" id="admin-key-input" name="password" 
                class="admin-input" placeholder="••••••••••••" 
                autocomplete="current-password">
            
            <button type="submit" id="login-btn" class="primary-submit-btn">
                ESTABLISH CONNECTION
            </button>
            
        </form>
    </div>

    <div id="admin-content" class="admin-content-hidden">
        <h1 class="neon-text dashboard-title">GAME STATE MONITOR</h1>
        
        <div class="admin-grid">
            <div class="admin-card">
                <h2>System Status</h2>
                <div class="data-row">
                    <span class="metric-label">Supabase</span>
                    <span id="db-status" class="status-up">--</span>
                </div>
                <div class="data-row">
                    <span class="metric-label">Upstash</span>
                    <span id="redis-status" class="status-up">--</span>
                </div>
            </div>
            
            <div class="admin-card">
                <h2>Operational Clocks</h2>
                <div class="data-row">
                    <span class="metric-label">Days Live</span>
                    <span id="real-day" class="admin-metric">0</span>
                </div>
                <div class="data-row">
                    <span class="metric-label">Stream Days</span>
                    <span id="stream-day" class="admin-metric">0</span>
                </div>
                <div class="data-row">
                    <span class="metric-label">Last Maintenance</span>
                    <span id="last-maint" class="data-value">--</span>
                </div>
            </div>

            <div class="admin-card">
                <h2>Global Economy</h2>
                <div class="data-row">
                    <span class="metric-label">Gross Spent</span>
                    <span id="gross-spent" class="data-value">0</span>
                </div>
                <div class="data-row">
                    <span class="metric-label">Total Refunded</span>
                    <span id="refunded" class="data-value economy-red">0</span>
                </div>
                <hr class="admin-hr">
                <div class="data-row">
                    <span class="neon-text metric-label">Net Flow</span>
                    <span id="net-economy" class="admin-metric">0</span>
                </div>
            </div>

           <div class="admin-card">
                <h2>Asset Allocation</h2>
                <div class="data-row">
                    <span class="metric-label">Community Chest</span>
                    <span id="chest" class="admin-metric">0</span>
                </div>
                <div class="data-row">
                    <span class="metric-label">Returned to Pushers</span>
                    <span id="returned-to-pushers" class="admin-metric">0</span>
                </div>
                <hr class="admin-hr-dashed">
                <div class="data-row">
                    <span class="metric-label">Removal Redistribution</span>
                    <span id="removal-redistribution-total" class="data-value">0</span>
                </div>
            </div>
        </div>
    </div>

<script>
const getApiBaseUrl = () => {
    const host = window.location.hostname;
    if (['localhost', '127.0.0.1', '0.0.0.0'].includes(host)) return 'http://127.0.0.1:3000/api/v1';
    return host.startsWith('192.168.') ? `http://${host}:3000/api/v1` : 'https://drummer-manager-api.vercel.app/api/v1';
};

const API_BASE_URL = getApiBaseUrl();
let refreshInterval = null;

function unlock(event) {
    if (event) event.preventDefault();
    const key = document.getElementById('admin-key-input').value;
    const feedback = document.getElementById('login-feedback');
    if (!key) return feedback.textContent = "KEY REQUIRED";
    sessionStorage.setItem('dmg_admin_key', key);
    updateDashboard();
}

async function updateDashboard() {
    const key = sessionStorage.getItem('dmg_admin_key');
    if (!key) return;

    try {
        const res = await fetch(`${API_BASE_URL}/admin/pulse`, {
            headers: { 'X-Admin-Secret': key }
        });

        if (res.status === 401) {
            document.getElementById('login-feedback').textContent = "INVALID SECRET";
            sessionStorage.removeItem('dmg_admin_key');
            return;
        }

        const data = await res.json();
        if (data.status !== "OK") {
            document.getElementById('login-feedback').textContent = data.message || "API ERROR";
            return;
        }
        
        // Use class toggle instead of inline display
        document.getElementById('login-overlay').classList.add('hidden');
        document.getElementById('admin-content').classList.remove('admin-content-hidden');

        const { systems, financials, maintenance } = data;

        const db = document.getElementById('db-status');
        const rd = document.getElementById('redis-status');
        db.textContent = systems.supabase;
        db.className = systems.supabase === 'UP' ? 'status-up' : 'status-down';
        rd.textContent = systems.upstash;
        rd.className = systems.upstash === 'UP' ? 'status-up' : 'status-down';

        document.getElementById('real-day').textContent = maintenance.realDay;
        document.getElementById('stream-day').textContent = maintenance.streamDay;

        const maintDisplay = document.getElementById('last-maint');
        if (maintenance.lastRun) {
            const dateObj = new Date(maintenance.lastRun);
            maintDisplay.textContent = dateObj.toISOString().replace('T', ' ').substring(0, 19) + ' UTC';
        } else {
            maintDisplay.textContent = "NEVER";
        }

        document.getElementById('gross-spent').textContent = Number(financials.grossSpent).toLocaleString();
        document.getElementById('refunded').textContent = Number(financials.refunded).toLocaleString();
        document.getElementById('net-economy').textContent = Number(financials.netEconomy).toLocaleString();

        document.getElementById('chest').textContent = Number(financials.communityChest).toLocaleString();
        document.getElementById('returned-to-pushers').textContent = Number(financials.totalToPushers).toLocaleString();
        document.getElementById('removal-redistribution-total').textContent = Number(financials.totalCausedByRemovals).toLocaleString();

        if (!refreshInterval) refreshInterval = setInterval(updateDashboard, 60000);

    } catch (err) {
        console.error("Dashboard Sync Error:", err);
        document.getElementById('login-feedback').textContent = "CONNECTION ERROR";
    }
}

if (sessionStorage.getItem('dmg_admin_key')) {
    updateDashboard();
}
</script>
</body>
</html>