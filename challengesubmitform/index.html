<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drummer Manager: Propose a Challenge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="../styles.css">
    <style>
        /* Specific Styles for Challenge Submission Form */

        /* Smaller Description Text */
        .desc-text-custom {
            font-size: 11px; /* Smaller than text-xs (12px) */
            line-height: 1.35;
        }

        /* --- Structural/Behavioral --- */
        .form-container {
            padding: 15px !important; 
            margin-top: 1rem !important;
            margin-bottom: 70px !important; 
        }

        .step-container {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .step-container.hidden {
            display: none;
        }
        
        /* --- Success/Confetti Animation Keyframes (MUST stay here if not moving to styles.css) --- */
        .starburst-glow {
            animation: glow-pulse 2s infinite alternate;
        }
        
        @keyframes glow-pulse {
            from { transform: translate(-50%, -50%) scale(0.8); opacity: 0.6; }
            to { transform: translate(-50%, -50%) scale(1.1); opacity: 0.8; }
        }
        
        /* --- NEW: Platform Color Classes for Identity Reminder (Uses variables from styles.css) --- */
        .platform-twitch { color: var(--platform-twitch); }
        .platform-youtube { color: var(--platform-youtube); }
        .platform-kick { color: var(--platform-kick); }
    </style>
</head>
<body class="dm-sans"> 
    <div class="form-container mx-auto" id="form-wrapper">
        <div class="flex justify-between items-start mb-4">
            <div class="text-left mt-1">
                <div class="dm-sans text-3xl font-extrabold neon-text leading-tight">
                    DRUMMER
                </div>
                <div class="roboto font-normal text-lg text-white tracking-widest leading-none">
                    MANAGER
                </div>
            </div>
            
            <div class="flex items-center space-x-1">
                <span id="streamStatusText" class="roboto text-xs text-gray-400">OFFLINE</span>
                <div id="streamStatusIndicator" class="stream-status-indicator offline"></div>
            </div>
        </div>
        
        <p id="identityReminder" class="roboto text-xs text-center text-gray-400 mt-2 mb-4 hidden border-b border-[#333] pb-2">
            Submitting as: <strong id="reminderUsername"></strong> on <strong id="reminderPlatform"></strong>
        </p>

        <form id="challengeForm">
            <div id="step1" class="step-container text-center">
                <div class="form-group">
                    <i id="statusIcon" class="fa-solid fa-spinner text-3xl mb-4"></i>
                    <p id="statusMessage1" class="roboto text-sm text-center text-gray-400">
                        Verifying secure link...
                    </p>
                </div>
            </div>

            <div id="step2" class="step-container hidden">
                
                <div id="durationTypeGroup" class="form-group">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                        
                        <div class="duration-card w-full flex flex-col h-full" data-duration="ONE_OFF">
                            <h4 class="dm-sans font-bold text-sm mb-0">One-Off Challenge</h4>
                            <p class="roboto text-gray-400 flex-grow mt-1 mb-0 desc-text-custom" id="oneOffDescription">
                                Continuous effort, must be completed within one stream day (21-min units).
                            </p>
                        </div>
                        
                        <div class="duration-card w-full flex flex-col h-full" data-duration="RECURRING">
                            <h4 class="dm-sans font-bold text-sm mb-0">Recurring Challenge</h4>
                            <p class="roboto text-gray-400 flex-grow mt-1 mb-0 desc-text-custom" id="recurringDescription">
                                Multi-session task scheduled across multiple days/weeks. Requires cadence.
                            </p>
                        </div>
                        
                    </div>
                </div>

                <div id="challengeTextGroup" class="form-group mt-4 form-section-disabled">
                    <div id="challengeEditor" 
                        class="form-input p-2 rounded-t-lg shadow-sm w-full bg-[#1a1a1a] text-white border border-[#333]" 
                        style="min-height: 100px; max-height: 300px; overflow-y: auto;"
                        contenteditable="true"
                        placeholder="Describe the task. (Min 10 chars) Tip: Use an AI tool like Gemini to help you formulate a clear suggestion!"
                        disabled
                        required>
                    </div>
                    
                    <input type="hidden" id="challengeText" value="">

                    <div class="flex border-t-0 border border-[#333] rounded-b-lg p-2 bg-[#2a2a2a]">
                        <button type="button" data-edit="bold" 
                                class="editor-button text-gray-400 hover:text-white disabled:opacity-50 disabled:pointer-events-none w-8 h-8 rounded-md hover:bg-[#3d3d3d] flex justify-center items-center mr-1"
                                title="Bold" disabled>
                            <i class="fa-solid fa-bold"></i>
                        </button>
                        <button type="button" data-edit="italic" 
                                class="editor-button text-gray-400 hover:text-white disabled:opacity-50 disabled:pointer-events-none w-8 h-8 rounded-md hover:bg-[#3d3d3d] flex justify-center items-center mr-1"
                                title="Italic" disabled>
                            <i class="fa-solid fa-italic"></i>
                        </button>
                    </div>
                </div>
                
                <div id="timePaceGroup" class="form-group mt-6 form-section-disabled">
                    <div id="oneOffGroup" class="form-group hidden">
                        <label for="totalTimeframeCount" class="roboto text-sm text-gray-400 block mb-1">Total 21-min Sessions:</label>
                        <div class="flex items-center gap-3">
                            <input type="number" id="totalTimeframeCount" class="form-input cadence-input" min="1" value="1" max="999" disabled required>
                            <span class="roboto text-sm">Session(s)</span>
                            
                            <div class="ml-auto flex items-center bg-[#1a1a1a] px-3 py-1 rounded border border-[#333]">
                                <span class="roboto text-xs text-gray-400 mr-2">Cost:</span>
                                <span id="oneOffCostDisplay" class="neon-text font-bold">--</span> 
                                <span class="text-xs text-gray-500 ml-1">NUMBERS</span>
                            </div>
                        </div>
                    </div>

                    <div id="cadenceGroup" class="form-group hidden">
                        <label class="roboto text-sm text-gray-400 block mb-1">Set Cadence:</label>
                        
                        <div id="cadenceFieldsWrapper" class="space-y-2 mt-2">
                            
                            <div class="flex flex-wrap items-center gap-2 text-sm">
                                <span class="roboto">Do</span> 
                                <input type="number" id="cadenceCount" class="form-input cadence-input" value="1" min="1" max="999" disabled>
                                <span class="roboto">session(s)</span>
                                
                                <select id="cadenceUnit" class="form-input" style="width: 120px !important; padding: 5px 8px !important;" disabled>
                                    <option value="" disabled selected class="hidden">select frequency</option>
                                    <option value="DAILY">per Day</option>
                                    <option value="WEEKLY">per Week</option>
                                    <option value="MONTHLY">per Month</option>
                                    <option value="CUSTOM_DAYS">every X days</option> 
                                </select>
                            </div>

                            <div id="customDaysGroup" class="hidden flex flex-wrap items-center gap-2 text-sm">
                                <span class="roboto">Every</span>
                                <input type="number" id="customDaysCount" class="form-input cadence-input" value="2" min="2" max="365" disabled>
                                <span class="roboto">days</span>
                            </div>
                            
                            <div id="durationGroup" class="hidden flex flex-wrap items-center gap-2 text-sm">
                                <span id="durationLeadInText" class="roboto">for a total of</span>
                                <input type="number" id="recurrenceDurationCount" class="form-input cadence-input" min="1" max="999" value="1" disabled>
                                <span id="timeframeUnitSentence" class="roboto">Weeks</span>
                            </div>
                        </div>

                        <div id="totalSummaryWrapper" class="mt-3 text-xs text-gray-400 pt-3 border-t border-[#333] flex justify-between items-center">
                            <div>
                                <span class="roboto">Total Sessions Estimate:</span>
                                <strong id="cadencePreview" class="neon-text ml-1">...</strong>
                            </div>
                            
                            <div class="flex items-center bg-[#1a1a1a] px-3 py-1 rounded border border-[#333]">
                                <span class="roboto text-xs text-gray-400 mr-2">Cost:</span>
                                <span id="recurringCostDisplay" class="neon-text font-bold">--</span> 
                                <span class="text-xs text-gray-500 ml-1">NUMBERS</span>
                            </div>
                        </div>
                    </div>
                    
                    <input type="hidden" id="sessionCadenceText">
                    <input type="hidden" id="calculatedTotalSessions" value="0">
                    <input type="hidden" id="challengeDurationType">
                    <input type="hidden" id="calculatedCost" value="0">
                </div>

                <div id="highDemandWarningBanner" class="high-demand-warning hidden mt-5 p-4 rounded-lg">
                    <p class="roboto text-lg font-bold" style="color: var(--primary-neon);">
                        ⚠️ HIGH-DEMAND CHALLENGE WARNING ⚠️
                    </p>
                    <p id="highDemandWarningText" class="roboto mt-2 text-sm" style="color: rgba(242, 189, 21, 0.7);">
                        This submission requires [X] sessions per [Period], which far exceeds the normal demand threshold. If activated, it will rapidly monopolize the execution slot for an extended duration.
                    </p>
                    <p class="roboto mt-3 text-xs italic" style="color: var(--error-red);">
                        <strong>REMINDER:</strong> The Game Master (Drummer, 21) has the ultimate authority to remove any challenge deemed inadmissible or too disruptive. Be warned: <strong>Once submitted, you never know what might happen...</strong>
                    </p>
                </div>

                <button type="submit" id="submitButton" class="interactive-button form-button mt-4" disabled>
                    SUBMIT
                    <span class="info-tooltip-container">
                        ⓘ
                        <span class="info-tooltip-text" style="width: 180px; margin-left: -90px;"> 
                            This is final! Clicking 'SUBMIT' will deduct the calculated NUMBERS cost from your balance.
                        </span>
                    </span>
                </button>
                <p id="statusMessage2" class="roboto text-sm text-center mt-3"></p>
            </div>

            <div id="step3" class="step-container hidden text-center">
                
                <div class="starburst-container">
                    <div class="starburst-glow"></div> 
                    
                    <h3 class="dm-sans text-xl font-bold text-white mb-2" style="text-shadow: 0 0 10px rgba(242, 189, 21, 0.5); position: relative; z-index: 1;">
                        CHALLENGE ACCEPTED!
                    </h3>
                </div>
                
                <p class="roboto text-base text-white mb-4">
                    Thank you for engaging, your support is highly appreciated.
                </p>

                <div id="summaryContent" class="text-left p-3 rounded-lg border border-[#333] bg-[#1a1a1a] text-sm">
                    </div>
                
                <h4 class="form-heading text-base mt-4">What's Next?</h4>
                <p class="roboto text-xs text-gray-400 mb-4">
                    Track this challenge, engage with other Producers, and suggest more.
                </p>
                
                <div id="postSubmissionActions" class="flex justify-center flex-wrap gap-3">
                    <a href="https://www.twitch.tv/21xhr" target="_blank" aria-label="Go Back to the Stream (Twitch)" class="social-link flex flex-col items-center text-xs text-center">
                        <i class="fab fa-twitch text-purple-600 text-2xl"></i>
                        <span class="mt-1 text-gray-400">Go to Stream</span>
                    </a>
                    <a href="https://discord.gg/av9bpn6Zhp" target="_blank" aria-label="Join the Discussion (Discord)" class="social-link flex flex-col items-center text-xs text-center">
                        <i class="fab fa-discord text-indigo-400 text-2xl"></i>
                        <span class="mt-1 text-gray-400">Join Discussion</span>
                    </a>
                    <a id="shareChallengeButton" href="#" target="_blank" class="social-link flex flex-col items-center text-xs text-center" aria-label="Share Challenge">
                        <i class="fa-solid fa-share-nodes text-primary-neon text-2xl"></i>
                        <span class="mt-1 text-gray-400">Share This!</span>
                    </a>
                </div>

                <button type="button" id="startNewChallengeButton" class="interactive-button form-button mt-4 py-2 px-4">
                    Start a New Proposal
                </button>
            </div>
            
        </form>
    </div>

    <div class="fixed-social-links-container py-4 z-50 text-center bg-[#0c0c0c]/90 backdrop-blur-sm flex-shrink-0">
        <h2 class="dm-sans text-xs md:text-sm text-white font-bold mb-2">Follow 21 Everywhere</h2>
        <div class="flex justify-center space-x-6 text-xl md:text-2xl">
            <a href="https://discord.gg/av9bpn6Zhp" target="_blank" aria-label="Discord" class="social-link">
                <i class="fab fa-discord"></i>
            </a>
            <a href="https://www.facebook.com/21xhr" target="_blank" aria-label="Facebook" class="social-link">
                <i class="fab fa-facebook-f"></i>
            </a>
            <a href="https://www.instagram.com/21xhr_" target="_blank" aria-label="Instagram" class="social-link">
                <i class="fab fa-instagram"></i>
            </a>
            <a href="https://www.twitch.tv/21xhr" target="_blank" aria-label="Twitch" class="social-link">
                <i class="fab fa-twitch"></i>
            </a>
            <a href="https://x.com/21xhr" target="_blank" aria-label="X" class="social-link">
                <i class="fab fa-x-twitter"></i>
            </a>
            <a href="https://www.youtube.com/@21xhr" target="_blank" aria-label="YouTube" class="social-link">
                <i class="fab fa-youtube"></i>
            </a>
            <a href="https://21xhr.github.io/drummer-manager/donation" target="_blank" aria-label="Make a Donation" class="social-link">
                <i class="fa-solid fa-mug-hot"></i>
            </a>
        </div>
    </div>


<script>
    // --- CONFIG ---
    const SESSION_DURATION_MINUTES = 21;
    const BASE_COST_PER_SESSION = 210;
    const LIVE_DISCOUNT_FACTOR = 0.79;
    let submissionToken = '';
    let selectedPlatform = '';
    let selectedPlatformId = '';
    let isStreamLive = false;
    let baseChallengeCost = BASE_COST_PER_SESSION;
    let challengeTextCache = ''; // Cache challenge text for UX

    const DEFAULT_PLACEHOLDER = 'Describe the task. (Min 10 chars) \nTip: Use an AI tool like Gemini to help you formulate a clear suggestion!';
    const RECURRING_PLACEHOLDER = 'Describe the task. (Min 10 chars) \nReminder: Use the section below to define the cadence, NOT here.';
    const ONE_OFF_PLACEHOLDER = 'Describe the task. (Min 10 chars) \nReminder: Use the section below to define the total 21-min sessions, NOT here.';

   // --- API URL LOGIC (The most robust dual-path) ---
    const getApiBaseUrl = () => {
        const hostname = window.location.hostname;
        
        // 1. If accessed via the Mac's true loopback aliases (localhost, 127.0.0.1, 0.0.0.0), use loopback for API call.
        if (hostname === 'localhost' || hostname === '127.0.0.1' || hostname === '0.0.0.0') {
            return 'http://127.0.0.1:3000/api/v1'; 
        }
        
        // 2. If accessed via the local network IP (i.e., your phone using 192.168.1.37), use that IP.
        if (hostname.startsWith('192.168.')) {
            // Use the IP the form was accessed on, which the phone can reach.
            return `http://${hostname}:3000/api/v1`; 
        }

        // 3. Production fallback
        return 'https://drummer-manager-api.vercel.app/api/v1';
    };

    let API_BASE_URL = getApiBaseUrl(); // Use 'let' for the override below
    

    // --- DOM REFERENCES ---
    const form = document.getElementById('challengeForm');
    const formWrapper = document.getElementById('form-wrapper');
    const formTitle = document.getElementById('formTitle');
    const step1 = document.getElementById('step1');
    const statusIcon = document.getElementById('statusIcon');
    const step2 = document.getElementById('step2');
    const step3 = document.getElementById('step3');
    const streamStatusText = document.getElementById('streamStatusText');
    const streamStatusIndicator = document.getElementById('streamStatusIndicator');
    
    const statusMessage1 = document.getElementById('statusMessage1');
    const identityReminder = document.getElementById('identityReminder');
    const reminderUsername = document.getElementById('reminderUsername');
    const reminderPlatform = document.getElementById('reminderPlatform');
    const startNewChallengeButton = document.getElementById('startNewChallengeButton'); // Renamed for clarity
    
    const durationTypeGroup = document.getElementById('durationTypeGroup');
    const durationCards = formWrapper.querySelectorAll('.duration-card');

    const challengeTextGroup = document.getElementById('challengeTextGroup');
    // challengeEditor is the contenteditable DIV
    const challengeEditor = document.getElementById('challengeEditor'); 
    // challengeText is now the hidden INPUT holding the final HTML
    const challengeText = document.getElementById('challengeText');

    const timePaceGroup = document.getElementById('timePaceGroup');
    const currentCostDisplay = document.getElementById('currentCostDisplay');
    const oneOffGroup = document.getElementById('oneOffGroup');
    const totalTimeframeCountInput = document.getElementById('totalTimeframeCount'); 
    const cadenceGroup = document.getElementById('cadenceGroup');
    const cadenceUnitSelect = document.getElementById('cadenceUnit');
    const cadenceCountInput = document.getElementById('cadenceCount');
    const customDaysGroup = document.getElementById('customDaysGroup');
    const customDaysInput = document.getElementById('customDaysCount'); 
    const recurrenceDurationCountInput = document.getElementById('recurrenceDurationCount');
    const timeframeUnitSentenceSpan = document.getElementById('timeframeUnitSentence');
    const cadencePreview = document.getElementById('cadencePreview');
    const sessionCadenceHidden = document.getElementById('sessionCadenceText');
    const calculatedTotalSessionsInput = document.getElementById('calculatedTotalSessions');
    const challengeDurationTypeHidden = document.getElementById('challengeDurationType');
    const durationGroup = document.getElementById('durationGroup');
    const durationLeadInText = document.getElementById('durationLeadInText');
    const submitButton = document.getElementById('submitButton');
    const statusMessage2 = document.getElementById('statusMessage2');
    const calculatedCostInput = document.getElementById('calculatedCost');
    const summaryContent = document.getElementById('summaryContent');
    const shareChallengeButton = document.getElementById('shareChallengeButton');
    const highDemandWarningBanner = document.getElementById('highDemandWarningBanner');
    const highDemandWarningText = document.getElementById('highDemandWarningText');

    // Reference to the 'every X days' option element for UI toggle
    const customDaysOption = document.querySelector('#cadenceUnit option[value="CUSTOM_DAYS"]');

    // --- STEP MANAGEMENT ---
    let currentStep = 1;

    const renderStep = (step) => {
        currentStep = step;
        step1.classList.add('hidden');
        step2.classList.add('hidden');
        step3.classList.add('hidden');
        
        if (step === 1) {
            step1.classList.remove('hidden');
            identityReminder.classList.add('hidden');
            // Re-hide identity reminder for step 1
        } else if (step === 2) {
            step2.classList.remove('hidden');
            identityReminder.classList.remove('hidden');
        } else if (step === 3) {
            step3.classList.remove('hidden');
            identityReminder.classList.remove('hidden');
        }
        window.scrollTo(0, 0); 
    };
    
    // --- TOKEN VERIFICATION LOGIC ---
    const verifyTokenAndStartForm = async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        
        if (!token) {
            statusIcon.classList.remove('fa-spinner', 'fa-spin', 'neon-text');
            statusIcon.classList.add('fa-lock', 'text-red-500');
            statusMessage1.style.color = 'var(--error-red, red)'; // Use a fallback color
            statusMessage1.innerHTML = `
                ACCESS DENIED <br> This page must be accessed via a secure link generated from the stream chat. 
                <br>Please use the command ** !challengesubmit ** in chat to get a valid link.
            `;
            return;
        }

        submissionToken = token;

        // Apply classes for the icon and the spin
        statusIcon.classList.add('fa-spinner', 'fa-spin');
        statusIcon.classList.remove('fa-lock', 'fa-triangle-exclamation', 'fa-hourglass-half', 'fa-circle-check', 'text-success-green', 'text-red-500');
        
        // Use an explicit style property to apply the neon color only, 
        // avoiding the 'fa-spin' conflicting 'neon-text' class.
        statusIcon.style.color = 'var(--primary-neon)'; 
        statusIcon.style.textShadow = '0 0 5px var(--primary-neon)'; // OPTIONAL: Add a soft glow effect 
        
        statusMessage1.style.color = 'var(--text-color)';
        statusMessage1.textContent = 'Verifying your Producer credentials via secure link...';

        try {
            // Enforce a minimum display time for the "Verifying" message
            const MIN_VERIFY_DELAY_MS = 2100; 
            
            const apiCall = fetch(`${API_BASE_URL}/token/verify`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: submissionToken })
            });

            // Wait for both the API call to complete AND the minimum delay to pass
            const [response] = await Promise.all([
                apiCall,
                new Promise(resolve => setTimeout(resolve, MIN_VERIFY_DELAY_MS))
            ]);

            // Note: We await the response again to get the JSON data
            const data = await response.json();

            if (response.ok) {
                // Success Logic
                selectedPlatformId = data.username; 
                selectedPlatform = data.platformName;

                reminderUsername.textContent = selectedPlatformId;
                reminderPlatform.textContent = selectedPlatform;
                
                // Apply platform styling to username and platform name
                reminderUsername.className = '';
                reminderPlatform.className = '';
                
                const platformClass = `platform-${selectedPlatform.toLowerCase()}`;
                
                reminderUsername.classList.add(platformClass);
                reminderPlatform.classList.add(platformClass);

                statusIcon.classList.remove('fa-spinner', 'fa-spin', 'neon-text');
                statusIcon.classList.add('fa-circle-check', 'text-success-green');
                statusMessage1.style.color = 'var(--success-green)';
                

                // 2. Success message is displayed with a Delay
                statusMessage1.textContent = `Identity Verified! Submitting as ${selectedPlatformId} on ${selectedPlatform}. Key expires soon.`;

                // Delay for user to read the success message before transition
                setTimeout(() => {
                    renderStep(2); // 3. Enter challenge submission (Step 2)
                    statusMessage1.textContent = ''; 
                }, 2100); 

            } else if (response.status === 401 || response.status === 400) {
                // TOKEN EXPIRED/INVALID FAILURE
                const apiMessage = data.message || 'The secure link you used is no longer valid. Please get a new token.';
                
                // Determine a concise title from the API error field (if available)
                const title = (data.error && data.error.includes('expired')) 
                    ? 'LINK EXPIRED' 
                    : (data.error && data.error.includes('invalid')) 
                    ? 'LINK INVALID/MALFORMED'
                    : 'AUTHENTICATION FAILED'; // Default
                                 
                statusIcon.classList.remove('fa-spinner', 'fa-spin', 'neon-text');
                statusIcon.classList.add('fa-hourglass-half', 'text-yellow-500'); 
                statusMessage1.style.color = 'var(--primary-neon)';
                
                // Inject the specific error message from the API response
                statusMessage1.innerHTML = `
                    <span class="dm-sans font-bold text-lg">${title}</span>
                    <p class="roboto mt-2 mb-3">
                        ${apiMessage}
                    </p>
                `; // 3. Fall back (Display static error)
            } else {
                // Generic Verification Failure (e.g., 500 server error)
                statusIcon.classList.remove('fa-spinner', 'fa-spin', 'neon-text');
                statusIcon.classList.add('fa-triangle-exclamation', 'text-red-500');
                statusMessage1.style.color = 'var(--error-red, red)';
                statusMessage1.innerHTML = `
                    **Verification Failed!** An unknown server error occurred during verification.
                    <br>Please try again or check the server status.
                `;
            }

        } catch (error) {
            // TRUE NETWORK ERROR (Client cannot physically reach the server)
            statusIcon.classList.remove('fa-spinner', 'fa-spin', 'neon-text');
            statusIcon.classList.add('fa-server', 'text-red-500');
            statusMessage1.style.color = 'var(--error-red, red)';
            statusMessage1.textContent = `CRITICAL ERROR: Could not connect to the API server (${API_BASE_URL}). Check server status.`;
            console.error('Verification Network Error:', error);
        }
    };

    // --- STREAM STATUS & COST LOGIC ---
    const fetchStreamStatus = async () => {
        try {
            const response = await fetch(`${API_BASE_URL}/stream/stats`);
            const data = await response.json();
            
            isStreamLive = data.isStreamLive;
            
            if (isStreamLive) {
                streamStatusIndicator.classList.remove('offline');
                streamStatusIndicator.classList.add('live');
                streamStatusText.textContent = 'LIVE (21% Discount)';
                baseChallengeCost = Math.ceil(BASE_COST_PER_SESSION * LIVE_DISCOUNT_FACTOR);
            } else {
                streamStatusIndicator.classList.remove('live');
                streamStatusIndicator.classList.add('offline');
                streamStatusText.textContent = 'OFFLINE';
                baseChallengeCost = BASE_COST_PER_SESSION;
            }
        } catch (error) {
            streamStatusText.textContent = 'ERROR';
            console.error('Error fetching stream stats:', error);
            baseChallengeCost = BASE_COST_PER_SESSION; 
        }
        calculateTotalSessions();
    };

    // --- HELPER FUNCTIONS ---
    
    const updateDynamicFields = () => {
        // CRITICAL CHANGE: Read text length from the contenteditable div's plain text
        const textLength = challengeEditor.textContent.trim().length;
        const durationType = challengeDurationTypeHidden.value;
        const isRecurring = durationType === 'RECURRING';
        const isOneOff = durationType === 'ONE_OFF';

        // Update Placeholder based on selection (via the div's attribute)
        if (isRecurring) {
            challengeEditor.setAttribute('placeholder', RECURRING_PLACEHOLDER);
        } else if (isOneOff) {
            challengeEditor.setAttribute('placeholder', ONE_OFF_PLACEHOLDER);
        } else {
            challengeEditor.setAttribute('placeholder', DEFAULT_PLACEHOLDER);
        }
        

        // Trigger 1 (Duration Type Selection)
        if (durationType) {
            challengeTextGroup.classList.remove('form-section-disabled');
            // Enable the editor div and the toolbar buttons
            challengeEditor.removeAttribute('disabled');
            document.querySelectorAll('.editor-button').forEach(btn => btn.removeAttribute('disabled'));
            
            // UX FIX: The key fix is here: clear content if the user hasn't typed anything, 
            // ensuring the new CSS placeholder shows correctly.
            if (challengeEditor.textContent.trim().length === 0 || 
                challengeEditor.innerHTML.trim() === '<br>') { // Check for empty or just a line break
                challengeEditor.innerHTML = ''; 
            }
            
        } else {
            challengeTextGroup.classList.add('form-section-disabled');
            // Disable the editor div and the toolbar buttons
            challengeEditor.setAttribute('disabled', 'true');
            document.querySelectorAll('.editor-button').forEach(btn => btn.setAttribute('disabled', 'true'));
            
            // Set the specific disabled placeholder
            challengeEditor.setAttribute('placeholder', 'Please select a Duration Type above first.');
        }

        // Trigger 1 (Duration Type Selection)
        if (durationType) {
            challengeTextGroup.classList.remove('form-section-disabled');
            challengeText.disabled = false;
        } else {
            challengeTextGroup.classList.add('form-section-disabled');
            challengeText.disabled = true;
            challengeText.placeholder = 'Please select a Duration Type above first.';
        }

        // Trigger 2: Enable Time/Pace after sufficient challenge text is entered
        const canSetPace = durationType && textLength >= 10;
        
        if (canSetPace) {
            timePaceGroup.classList.remove('form-section-disabled');
            totalTimeframeCountInput.disabled = false;
            cadenceCountInput.disabled = false;
            cadenceUnitSelect.disabled = false;
            customDaysInput.disabled = false;
            recurrenceDurationCountInput.disabled = false;
            
            oneOffGroup.classList.toggle('hidden', !isOneOff);
            cadenceGroup.classList.toggle('hidden', !isRecurring);
            
            // Set default for recurring if not set
            if (isRecurring && !cadenceUnitSelect.value) {
                cadenceUnitSelect.value = 'DAILY';
                // Trigger the full reset if we had to set the default
                setCadenceTimeframeDefaults(cadenceUnitSelect.value); // This runs the first calculation
            }
            
        } else {
            timePaceGroup.classList.add('form-section-disabled');
            totalTimeframeCountInput.disabled = true;
            cadenceCountInput.disabled = true;
            cadenceUnitSelect.disabled = true;
            customDaysInput.disabled = true;
            recurrenceDurationCountInput.disabled = true;
            
            // Reset cost displays if sections are disabled
            const oneOffDisplay = document.getElementById('oneOffCostDisplay');
            const recurringDisplay = document.getElementById('recurringCostDisplay');
            if (oneOffDisplay) oneOffDisplay.textContent = '--';
            if (recurringDisplay) recurringDisplay.textContent = '--';

            cadencePreview.textContent = '...';
        }

        // CRITICAL: Ensure calculation runs BEFORE the submit check
        calculateTotalSessions();
        
        // Update submit button state
        const hasChallengeText = textLength >= 10;
        const hasDurationSelection = !!durationType;
        let hasSessions = false;
        
        // Ensure total sessions is calculated and >= 1. For recurring, ensure >= 2.
        const totalSessions = parseInt(calculatedTotalSessionsInput.value);
        if (totalSessions >= 1) { 
             // For Recurring, enforce a total of at least 2 sessions to be valid
             if (isRecurring && totalSessions < 2) {
                 hasSessions = false; 
             } else {
                hasSessions = true;
             }
        }
        
        submitButton.disabled = !(hasChallengeText && hasDurationSelection && hasSessions);

        // --- Call Warning Checker ---
        checkHighDemandWarning();
    };

    const setCadenceTimeframeDefaults = (unit) => {
        // Only set this up when recurring is active
        if (challengeDurationTypeHidden.value !== 'RECURRING') return;
        
        // --- UI: Manage visibility and text of the 'every X days' option ---
        if (customDaysOption) {
            if (unit === 'CUSTOM_DAYS') {
                // 1. Hide the option from the list
                customDaysOption.style.display = 'none';
                // 2. Clear the displayed text in the closed dropdown box to avoid redundancy
                customDaysOption.textContent = ' '; 
            } else {
                // 1. Show the option when any other unit is selected
                customDaysOption.style.display = 'block'; 
                // 2. Restore the original text
                customDaysOption.textContent = 'every X days'; 
            }
        }

        // IMPORTANT: Reset to preferred minimums when changing unit
        cadenceCountInput.value = '1'; 
        recurrenceDurationCountInput.value = '2';
        
        // This is only for display purposes in the sentence
        if (unit === 'DAILY') {
            timeframeUnitSentenceSpan.textContent = "Days";
        } else if (unit === 'WEEKLY') {
            timeframeUnitSentenceSpan.textContent = "Weeks";
        } else if (unit === 'MONTHLY') {
            timeframeUnitSentenceSpan.textContent = "Months";
        } else if (unit === 'CUSTOM_DAYS') {
            timeframeUnitSentenceSpan.textContent = "times";
        }

        customDaysGroup.classList.toggle('hidden', unit !== 'CUSTOM_DAYS');
        
        // We always call calculateTotalSessions to ensure all fields are updated
        calculateTotalSessions();
    };
    
    const calculateTotalSessions = () => {
        const durationType = challengeDurationTypeHidden.value;
        const isRecurring = durationType === 'RECURRING';

        let text = "";
        let calculatedTotal = 0;
        
        if (durationType === 'ONE_OFF') {
            calculatedTotal = Math.min(parseInt(totalTimeframeCountInput.value) || 1, 999);
            // Ensure minimum of 1 session for one-off
            if (calculatedTotal < 1) calculatedTotal = 1;
            totalTimeframeCountInput.value = calculatedTotal;
            text = `ONE_OFF: ${calculatedTotal} session(s).`;
            
        } else if (isRecurring) {
            const unit = cadenceUnitSelect.value;
            // Get user inputs, default to 1
            let pace = Math.min(parseInt(cadenceCountInput.value) || 1, 999);
            let timeframeCount = Math.min(parseInt(recurrenceDurationCountInput.value) || 1, 999); 
            const customDays = parseInt(customDaysInput.value) || 1;
            
            // --- Show durationGroup if a unit is selected and parent section is enabled ---
            if (unit && !timePaceGroup.classList.contains('form-section-disabled')) {
                durationGroup.classList.remove('hidden');
            }

            // --- CRITICAL: Minimums based on unit type ---
            if (unit === 'DAILY' || unit === 'CUSTOM_DAYS') {
                
                if (pace < 1) pace = 1; // Enforce minimum pace of 1
                
                // Enforce minimum duration of 2 units (days/times) for recurrence
                if (timeframeCount < 2) {
                    timeframeCount = 2; 
                }
                
            } else if (unit === 'WEEKLY' || unit === 'MONTHLY') {
                
                if (pace < 1) pace = 1; // Allow minimum pace of 1 session per week/month
                if (timeframeCount < 1) timeframeCount = 1; // Enforce minimum duration of 1 unit
                
                // If pace is 1, duration must be at least 2 units to ensure 2 total sessions
                if (pace === 1 && timeframeCount < 2) {
                    timeframeCount = 2;
                }
                
            }
            
            // 2. Update DOM fields with enforced minimums
            cadenceCountInput.value = pace;
            recurrenceDurationCountInput.value = timeframeCount;
            // --- End Enforcement ---

            // Correct logic: Total sessions = Pace * TimeframeCount
            calculatedTotal = pace * timeframeCount;
            
            if (!unit) {
                // If cadenceUnit is not selected yet
                text = "Select a frequency and duration to calculate total sessions.";
                calculatedTotal = 0;
                durationGroup.classList.add('hidden'); // Ensure it hides if unit is reset
            } else {
                
                // --- GRAMMAR FIXES ---
                const paceText = pace === 1 ? 'session' : 'sessions';
                let unitDisplay = unit.toLowerCase();
                
                // FIX: Map 'daily', 'weekly', 'monthly' to 'day', 'week', 'month'
                if (unitDisplay === 'daily') unitDisplay = 'day';
                else if (unitDisplay === 'weekly') unitDisplay = 'week';
                else if (unitDisplay === 'monthly') unitDisplay = 'month';
                
                const timeframeUnit = timeframeUnitSentenceSpan.textContent.toLowerCase(); // Fix capitalization

                if (unit === 'DAILY' || unit === 'WEEKLY' || unit === 'MONTHLY') {
                    // e.g., "1 session per day for 2 days"
                    text = `${pace} ${paceText} per ${unitDisplay} for ${timeframeCount} ${timeframeUnit}`;
                } else if (unit === 'CUSTOM_DAYS') {
                    // e.g., "1 session every 3 days for 4 times"
                    text = `${pace} ${paceText} every ${customDays} days for ${timeframeCount} times`;
                }
            }

            // Removed: redundant "= X Total Sessions" part
            durationLeadInText.textContent = unit === 'CUSTOM_DAYS' ? "then repeat this" : "for a total of";
        } else {
            text = "Select a Duration Type to continue.";
            calculatedTotal = 0;
        }
        
        const totalMinutes = calculatedTotal * SESSION_DURATION_MINUTES;
        const finalCost = baseChallengeCost;

        calculatedTotalSessionsInput.value = calculatedTotal;
        sessionCadenceHidden.value = text;
        calculatedCostInput.value = finalCost;
        
        cadencePreview.textContent = `${calculatedTotal.toLocaleString()} Sessions (${totalMinutes.toLocaleString()} Mins)`;
        
        // --- Define formattedCost here ---
        const formattedCost = finalCost.toLocaleString();

        // Update both displays (only the visible one will matter)
        const oneOffDisplay = document.getElementById('oneOffCostDisplay');
        const recurringDisplay = document.getElementById('recurringCostDisplay');
        
        if (oneOffDisplay) oneOffDisplay.textContent = formattedCost;
        if (recurringDisplay) recurringDisplay.textContent = formattedCost;
        
    };

    // --- WARNING LOGIC IMPLEMENTATION ---
    const checkHighDemandWarning = () => {
        const durationType = challengeDurationTypeHidden.value;
        const isRecurring = durationType === 'RECURRING';

        let shouldShowWarning = false;
        let sessionsPerPeriod = 0;
        let periodText = '';

        // If the duration card hasn't been selected or it's not recurring, we skip the check
        if (!isRecurring) {
            highDemandWarningBanner.classList.add('hidden');
            return;
        }

        const unit = cadenceUnitSelect.value;
        const pace = parseInt(cadenceCountInput.value) || 0;
        
        const THRESHOLDS = {
            'DAILY': 7,
            'WEEKLY': 42,
            'MONTHLY': 147,
        };

        if (unit === 'DAILY') {
            sessionsPerPeriod = pace;
            periodText = 'Day';
            if (pace > THRESHOLDS.DAILY) shouldShowWarning = true;
            
        } else if (unit === 'WEEKLY' || unit === 'MONTHLY') {
            sessionsPerPeriod = pace;
            // Use the display text from the global variable (Days, Weeks, Months)
            periodText = timeframeUnitSentenceSpan.textContent.slice(0, -1); 
            
            if (unit === 'WEEKLY' && pace > THRESHOLDS.WEEKLY) shouldShowWarning = true;
            if (unit === 'MONTHLY' && pace > THRESHOLDS.MONTHOLDS) shouldShowWarning = true;

        } else if (unit === 'CUSTOM_DAYS') {
            const customDays = parseInt(customDaysInput.value) || 1;
            // Normalized check: Average daily pace must be > 7 sessions/day
            const averageDailyPace = pace / customDays; 
            
            sessionsPerPeriod = pace; 
            periodText = ` ${customDays} Day cycle`;
            
            // Check against the DAILY threshold for the average pace
            if (averageDailyPace > THRESHOLDS.DAILY) {
                shouldShowWarning = true;
            }
        }
        
        // --- Update UI ---
        if (shouldShowWarning) {
            highDemandWarningText.innerHTML = `This submission requires <strong>${sessionsPerPeriod} session(s) per${periodText}</strong>, which far exceeds the normal demand threshold. If activated, it will rapidly monopolize the execution slot for an extended duration.`;
            highDemandWarningBanner.classList.remove('hidden');
        } else {
            highDemandWarningBanner.classList.add('hidden');
        }
    };

    const generateChallengeSummary = (challenge, cost, userStats) => {
        if (!challenge || !userStats) return `<p class="roboto" style="color: red;">Error: Challenge data or user stats are missing.</p>`;

        const isRecurring = challenge.durationType === 'RECURRING';
        
        const cadenceInfo = isRecurring ? `
            <p class="roboto" style="margin-top: 8px;">
                <strong>Cadence:</strong> ${challenge.sessionCadenceText}
            </p>
        ` : '';

        const statsInfo = `
            <div style="margin-top: 15px; padding: 8px; border: 1px dashed var(--primary-neon); background-color: rgba(242, 189, 21, 0.05); border-radius: 4px;">
                <h4 class="roboto" style="margin-top: 0; font-weight: bold; color: var(--primary-neon); font-size: 0.9rem;">Your Updated Stats:</h4>
                <p class="roboto" style="margin: 3px 0; font-size: 0.8rem;">
                    <strong>New Balance:</strong> ${userStats.currentBalance.toLocaleString()} NUMBERS 
                    </p>
                <p class="roboto" style="margin: 3px 0; font-size: 0.8rem;">
                    <strong>Total Challenges Proposed:</strong> ${userStats.totalChallengesSubmitted}
                </p>
            </div>
        `;

        const challengeUrl = `https://21xhr.github.io/drummer-manager/`; 
        const shareText = encodeURIComponent(`I just proposed Challenge #${challenge.challengeId} (Cost: ${cost.toLocaleString()} NUMBERS) to @21xhr on the Drummer Manager Game! #DrummerManager #ChallengeAccepted`);
        const twitterShare = `https://x.com/intent/tweet?text=${shareText}&url=${challengeUrl}`;
        
        shareChallengeButton.href = twitterShare;

        return `
            <h4 class="roboto font-bold text-white mb-2 border-b border-[#333] pb-1">Proposal Details:</h4>
            <p class="roboto text-sm">
                <strong>Cost:</strong> ${cost.toLocaleString()} NUMBERS
            </p>
            <p class="roboto text-sm">
                <strong>Challenge ID:</strong> #${challenge.challengeId}
            </p>
            <p class="roboto text-sm">
                <strong>Duration Type:</strong> ${challenge.durationType.replace('_', '-')}
            </p>
            <p class="roboto text-sm">
                <strong>Total Sessions:</strong> ${challenge.totalSessions} sessions (${challenge.totalSessions * SESSION_DURATION_MINUTES} Mins total)
            </p>
            ${cadenceInfo}

            <div style="margin-top: 10px; padding: 8px; border: 1px dashed #555; border-radius: 4px; background-color: #0d0d0d;">
                <strong>Challenge Text:</strong><br>
                <div style="color: #aaa; font-size: 0.9rem; text-align: left;">
                    ${challenge.challengeText}
                </div>
            </div>

            ${statsInfo} 
        `;
    };

    const resetForm = () => {
        // --- Store the token before clearing the global variable ---
        const tokenForRedirect = submissionToken; 

        // --- Clear internal state ---
        // Note: The global submissionToken is cleared here, 
        // but it's okay because we stored its value for the redirect.
        submissionToken = '';
        selectedPlatform = '';
        selectedPlatformId = '';
        challengeTextCache = ''; 
        
        form.reset();
        
        challengeDurationTypeHidden.value = '';
        durationCards.forEach(card => card.classList.remove('selected'));
        challengeText.value = '';
        challengeTextGroup.classList.add('form-section-disabled');
        challengeText.placeholder = DEFAULT_PLACEHOLDER;
        timePaceGroup.classList.add('form-section-disabled');
        oneOffGroup.classList.add('hidden');
        cadenceGroup.classList.add('hidden');
        submitButton.disabled = true;
        
        // --- Redirect using the stored token ---
        let newUrl = window.location.origin + window.location.pathname;

        if (tokenForRedirect) {
            newUrl += `?token=${tokenForRedirect}`;
        }
        
        // Reload the page to force token check
        window.location.href = newUrl;
    };

    // --- EVENT LISTENERS ---

    fetchStreamStatus();
    verifyTokenAndStartForm();

    
    // Step 2: Duration Card Selection (Trigger 1)
    durationCards.forEach(card => {
        card.addEventListener('click', () => {
            const type = card.getAttribute('data-duration');
            
            challengeTextCache = challengeText.value;

            durationCards.forEach(btn => btn.classList.remove('selected'));
            card.classList.add('selected');
            
            challengeDurationTypeHidden.value = type;

            challengeText.value = challengeTextCache;
            
            challengeTextGroup.classList.remove('form-section-disabled');
            challengeText.disabled = false;

            if (type === 'RECURRING') {
                if (!cadenceUnitSelect.value) {
                    cadenceUnitSelect.value = 'DAILY';
                }
                // DEFAULTS: 1 session per unit, for 2 units total (ensures minimum recurrence)
                cadenceCountInput.value = '1'; 
                recurrenceDurationCountInput.value = '2'; 
                
                setCadenceTimeframeDefaults(cadenceUnitSelect.value); // This runs calculation
            } else if (type === 'ONE_OFF') {
                if (totalTimeframeCountInput.value === '0') {
                    totalTimeframeCountInput.value = '1';
                }
            }
            
            updateDynamicFields(); 
        });
    });

    // Step 2: Challenge Text Input (Trigger 2)
    challengeText.addEventListener('input', () => {
        challengeTextCache = challengeText.value;
        updateDynamicFields();
    });

    // Step 2: Cadence/Session logic
    cadenceUnitSelect.addEventListener('change', (e) => {
        setCadenceTimeframeDefaults(e.target.value); 
    });
    // Input changes now call calculateTotalSessions indirectly via updateDynamicFields
    cadenceCountInput.addEventListener('input', updateDynamicFields);
    customDaysInput.addEventListener('input', updateDynamicFields);
    recurrenceDurationCountInput.addEventListener('input', updateDynamicFields); 
    totalTimeframeCountInput.addEventListener('input', updateDynamicFields);
    
    // Step 2: Form Submission
    form.addEventListener('submit', async (e) => { 
        e.preventDefault();
        
        if (!submissionToken) { 
            statusMessage2.style.color = 'var(--error-red)';
            statusMessage2.textContent = 'Error: Session key expired or missing. Please refresh the page.';
            return; 
        }
        
        submitButton.disabled = true;
        statusMessage2.style.color = 'var(--text-color)';
        statusMessage2.textContent = 'Submitting challenge...';

        const durationType = challengeDurationTypeHidden.value;
        
        const totalSessions = parseInt(calculatedTotalSessionsInput.value); 
        const cost = parseInt(calculatedCostInput.value);

        const submissionData = {
            token: submissionToken,
            challengeText: challengeText.value,
            totalSessions,
            durationType,
            cost,
            cadenceUnit: (durationType === 'RECURRING' ? cadenceUnitSelect.value : undefined),
            sessionCadenceText: (durationType === 'RECURRING' ? sessionCadenceHidden.value : undefined)
        };

        try {
            const response = await fetch(`${API_BASE_URL}/user/submit/web`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(submissionData)
            });

            // CRITICAL: Ensure response.json() is called *before* the success/error check
            const data = await response.json();

            if (response.ok) { 
                const payload = data.details; 
                const challengeData = payload.newChallenge;
                const cost = payload.cost;
                const userStats = payload.userStats; 
                
                summaryContent.innerHTML = generateChallengeSummary(challengeData, cost, userStats);
                
                statusMessage2.textContent = '✅ Challenge Submitted!'; // Add success confirmation
                statusMessage2.style.color = 'var(--success-green)';
                
                renderStep(3);

            } else {
                // Handle SERVER-SIDE errors (400, 401, 500) where the server returned JSON
                statusMessage2.style.color = 'var(--error-red)';
                statusMessage2.textContent = `SUBMISSION FAILED: ${data.message || data.error || 'Unknown server response'}`;
                submitButton.disabled = false;
            }
        } catch (error) {
            // This catch block is for true network failures or JSON parsing errors.
            console.error('Submission Network Error:', error);
            statusMessage2.style.color = 'var(--error-red)';
            statusMessage2.textContent = `NETWORK ERROR: Could not complete submission.`;
            submitButton.disabled = false;
        }
    });

    // --- WYSIWYG EDITOR LOGIC ---
    const updateHiddenChallengeText = () => {
        // Read the inner HTML from the contenteditable div
        const content = challengeEditor.innerHTML.trim();
        
        // Use a simple, non-HTML version for length check and placeholder
        const plainText = challengeEditor.textContent.trim();
        
        // Write the HTML content to the hidden input for submission
        challengeText.value = content; 
        
        // Return the plain text length for validation
        return plainText.length;
    };
    
    // --- CLEANED: execCommand no longer contains blockquote logic ---
    const execCommand = (command, value = null) => {
        // --- Standard Browser Command execution for all commands (Bold, Italic) ---
        challengeEditor.focus();
        
        try {
            document.execCommand(command, false, value);
        } catch (error) {
            console.error(`execCommand failed for ${command}:`, error);
        }

        updateDynamicFields(); 
    };

    // Toolbar button listeners
    document.querySelectorAll('.editor-button').forEach(button => {
        button.addEventListener('click', (e) => {
            e.preventDefault(); // Prevents the contenteditable div from losing focus on some browsers
            const command = button.getAttribute('data-edit');
            execCommand(command);
        });
    });

    // Update the hidden input and check validation on content change
    challengeEditor.addEventListener('input', () => {
        updateHiddenChallengeText(); // Update the hidden field on input
        updateDynamicFields(); // Trigger validation/cost check
    });

    
    startNewChallengeButton.addEventListener('click', resetForm);
</script>