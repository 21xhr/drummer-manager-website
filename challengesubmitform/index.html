<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drummer Manager: Propose a Challenge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="../css/global.css">
    <link rel="stylesheet" href="../css/challengesubmitform.css">
    <link rel="icon" href="data:,">

</head>
<body class="dm-sans">
    <audio id="bgMusic" loop>
        <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-17.mp3" type="audio/mpeg">
    </audio>

    <div class="form-container mx-auto" id="form-wrapper">
        
        <div class="flex justify-between items-stretch mb-6 min-h-[50px]"> 
            <div class="flex flex-col justify-center space-y-3">
                <div class="dm-sans text-3xl font-extrabold neon-text leading-[0.8]">DRUMMER</div>
                <div class="roboto font-normal text-lg text-white tracking-[0.25em] leading-[0.8]">MANAGER</div>
            </div>
            
            <div class="flex flex-col justify-between items-end text-right"> 
                <div class="flex items-center space-x-2">
                    <button type="button" id="muteToggle" class="text-gray-500 hover:text-primary-neon transition-colors">
                        <i id="muteIcon" class="fa-solid fa-volume-high text-[10px]"></i>
                    </button>
                    <span id="streamStatusText" class="roboto text-[10px] uppercase text-gray-400 tracking-tighter">OFFLINE</span>
                    <div id="streamStatusIndicator" class="stream-status-indicator offline"></div>
                </div>
                
                <div id="identityReminder" class="hidden">
                    <div class="flex flex-nowrap items-baseline justify-end space-x-1">
                        <span id="reminderUsername" class="roboto text-[11px] text-white font-bold leading-none"></span>
                        <div class="roboto text-[9px] text-gray-500 tracking-tighter flex-shrink-0">
                            on <span id="reminderPlatform" class="font-bold"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <form id="challengeForm">

            <div id="step1" class="step-container text-center">
                <div class="form-group">
                    <i id="statusIcon" class="fa-solid fa-spinner text-3xl mb-4"></i>
                    <p id="statusMessage1" class="roboto text-sm text-center text-gray-400">
                        Verifying secure link...
                    </p>
                </div>
            </div>

            <div id="step2" class="step-container hidden">
                
                <div id="durationTypeGroup" class="form-group">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                        <div class="duration-card p-4 flex items-center justify-center border border-[#222] rounded-lg hover:border-primary-neon transition-all" data-duration="ONE_OFF">
                            <h4 class="dm-sans font-black text-lg uppercase tracking-wider mb-0">
                                One-Off 
                                <span class="info-tooltip-container">
                                    <span class="text-s ml-1 lowercase">‚ìò</span>
                                    <span class="info-tooltip-text">Must be completed within the ONE stream day...</span>
                                </span>
                            </h4>
                        </div>
                        <div class="duration-card p-4 flex items-center justify-center border border-[#222] rounded-lg hover:border-primary-neon transition-all" data-duration="RECURRING">
                            <h4 class="dm-sans font-black text-lg uppercase tracking-wider mb-0">
                                Recurring 
                                <span class="info-tooltip-container">
                                    <span class="text-s ml-1 lowercase">‚ìò</span>
                                    <span class="info-tooltip-text">Multi-session task scheduled across multiple days...</span>
                                </span>
                            </h4>
                        </div>
                    </div>
                </div>

                <div id="challengeTextGroup" class="form-group mt-4 form-section-disabled">
                    <div id="challengeEditor" 
                        class="form-input p-2 rounded-t-lg shadow-sm w-full bg-[#1a1a1a] text-white border border-[#333]" 
                        style="min-height: 100px; max-height: 300px; overflow-y: auto;"
                        contenteditable="true"
                        placeholder="Describe the task. (Min 10 chars) 
                        Tip: Use an AI tool like Gemini to help you formulate a clear suggestion!"
                        required>
                    </div>
                    <input type="hidden" id="challengeText" value="">
                    <div class="flex border-t-0 border border-[#333] rounded-b-lg p-2 bg-[#2a2a2a]">
                        <button type="button" data-edit="bold" class="editor-button text-gray-400 hover:text-white disabled:opacity-50 disabled:pointer-events-none w-8 h-8 rounded-md hover:bg-[#3d3d3d] flex justify-center items-center mr-1" title="Bold" disabled>
                            <i class="fa-solid fa-bold"></i>
                        </button>
                        <button type="button" data-edit="italic" class="editor-button text-gray-400 hover:text-white disabled:opacity-50 disabled:pointer-events-none w-8 h-8 rounded-md hover:bg-[#3d3d3d] flex justify-center items-center mr-1" title="Italic" disabled>
                            <i class="fa-solid fa-italic"></i>
                        </button>
                    </div>
                </div>
                
                <div id="timePaceGroup" class="form-group mt-6 form-section-disabled">
                    <div id="oneOffGroup" class="form-group hidden">
                        <div class="summary-line-wrapper">
                            <div class="summary-badge flex items-center gap-2">
                                <span class="roboto text-xs text-gray-400 uppercase tracking-tighter">Total:</span>
                                <input type="number" id="totalTimeframeCount" class="form-input cadence-input" min="1" value="1" max="999" disabled required>
                                <span class="roboto neon-text text-sm">Session(s)</span>
                                <strong id="oneOffSummary" class="roboto text-[10px] neon-text ml-1"></strong>
                            </div>
                            
                            <div class="cost-badge-container summary-badge">
                                <span class="roboto text-xs text-gray-400 mr-2 uppercase">Cost:</span>
                                <span id="oneOffCostDisplay" class="neon-text font-bold text-sm">--</span> 
                                <span class="text-[9px] text-gray-500 ml-1 font-bold">NUMBERS</span>
                            </div>
                        </div>
                    </div>

                    <div id="cadenceGroup" class="form-group hidden">
                        <label for="cadenceCount" class="roboto text-sm text-gray-400 block mb-1">Set Cadence:</label>
                        <div id="cadenceFieldsWrapper" class="space-y-2 mt-2">
                            <div class="flex flex-wrap items-center gap-2 text-sm">
                                <span class="roboto">Do</span> 
                                <input type="number" id="cadenceCount" class="form-input cadence-input" value="1" min="1" max="999" disabled>
                                <span class="roboto">session(s)</span>
                                <select id="cadenceUnit" class="form-input" style="width: 120px !important; padding: 5px 8px !important;" disabled>
                                    <option value="" disabled selected class="hidden">select frequency</option>
                                    <option value="DAILY">per Day</option>
                                    <option value="WEEKLY">per Week</option>
                                    <option value="MONTHLY">per Month</option>
                                    <option value="CUSTOM_DAYS">every X days</option> 
                                </select>
                            </div>
                            <div id="customDaysGroup" class="hidden flex flex-wrap items-center gap-2 text-sm">
                                <span class="roboto">Every</span>
                                <input type="number" id="customDaysCount" class="form-input cadence-input" value="2" min="2" max="365" disabled>
                                <span class="roboto">days</span>
                            </div>
                            <div id="durationGroup" class="hidden flex flex-wrap items-center gap-2 text-sm">
                                <span id="durationLeadInText" class="roboto">for a total of</span>
                                <input type="number" id="recurrenceDurationCount" class="form-input cadence-input" min="1" max="999" value="1" disabled>
                                <span id="timeframeUnitSentence" class="roboto">Weeks</span>
                            </div>
                        </div>

                        <div id="totalSummaryWrapper" class="mt-3 pt-3 border-t border-[#333]">
                            <div class="summary-line-wrapper">
                                <div class="summary-badge flex items-center gap-2">
                                    <span class="roboto text-xs text-gray-400 uppercase tracking-tighter">Total:</span>
                                    <strong id="cadencePreview" class="neon-text text-sm">...</strong>
                                </div>

                                <div class="cost-badge-container summary-badge">
                                    <span class="roboto text-xs text-gray-400 mr-2 uppercase">Cost:</span>
                                    <span id="recurringCostDisplay" class="neon-text font-bold text-sm">--</span> 
                                    <span class="text-[9px] text-gray-500 ml-1 font-bold">NUMBERS</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <input type="hidden" id="sessionCadenceText">
                    <input type="hidden" id="calculatedTotalSessions" value="0">
                    <input type="hidden" id="challengeDurationType">
                    <input type="hidden" id="calculatedCost" value="0">
                </div>

                <div id="highDemandWarningBanner" class="high-demand-warning hidden mt-5 p-4 rounded-lg">
                    <p class="roboto text-lg font-bold" style="color: var(--primary-neon);">‚ö†Ô∏è HIGH-DEMAND CHALLENGE WARNING ‚ö†Ô∏è</p>
                    <p id="highDemandWarningText" class="roboto mt-2 text-sm" style="color: rgba(242, 189, 21, 0.7);">
                        This submission requires [X] sessions per [Period], which far exceeds the normal demand threshold.
                    </p>
                    <p class="roboto mt-3 text-xs italic" style="color: var(--error-red);">
                        <strong>REMINDER:</strong> Once submitted, you never know what might happen...
                    </p>
                </div>
                <div class="submit-row-container">
                    <button type="submit" id="submitButton" class="interactive-button form-button mt-4" disabled>
                        <div class="flex flex-col items-center leading-none">
                            <span class="main-btn-text">SUBMIT</span>
                            <div id="btnSubtext" class="flex items-center gap-2 transition-opacity duration-300 mt-1.5">
                                <i class="fa-solid fa-triangle-exclamation text-[8px]"></i>
                                <span class="roboto text-[9px] tracking-[0.2em]">THIS IS FINAL</span>
                                <i class="fa-solid fa-triangle-exclamation text-[8px]"></i>
                            </div>
                        </div>
                    </button>
                    <p id="statusMessage2" class="roboto text-sm text-center mt-3"></p>
                </div>
            </div>

            <div id="step3" class="step-container hidden animate-fadeIn">
                <div id="step3_header" class="header-container-step3">
                    <h2 class="dm-sans text-4xl font-black neon-text tracking-[0.2em] uppercase">SUCCESSFUL</h2>
                    <button type="button" id="startNewChallengeButton" title="Submit Another">
                        <i class="fa-solid fa-rotate-right"></i>
                    </button>
                </div>

                <div class="flex flex-col space-y-4">
                    <div class="success-card-main bg-[#0a0a0a] p-6 rounded-lg border border-[#222] shadow-2xl">
                        <div class="success-card-content">
                            
                            <div class="flex-1 flex flex-col items-center sm:items-start text-center sm:text-left">
                                <h3 class="dm-sans text-[14px] font-black text-white uppercase tracking-widest leading-none mb-1">What's Next?</h3>
                                <p class="roboto text-[11px] uppercase tracking-widest font-medium">Join the mission</p>
                            </div>
                            
                            <div class="glow-arrow-wrapper">
                                <div class="glow-arrow-container">
                                    <i class="fa-solid fa-angles-right text-primary-neon text-xl glow-arrow sm:rotate-0 rotate-90"></i>
                                </div>
                            </div>
                            
                            <div class="flex-1 flex flex-col gap-2 w-full max-w-[280px] sm:max-w-none">
                                <a href="https://youtube.com/@21xhr/live" target="_blank" id="streamLink" class="flex items-center justify-center gap-2 py-2.5 bg-[#f2bd15] text-black font-black text-[10px] uppercase hover:scale-[1.02] transition-transform">
                                    <i class="fa-solid fa-play text-[9px]"></i> <span id="streamBtnText">WATCH STREAM</span>
                                </a>
                                
                                <a href="https://discord.gg/yourlink" target="_blank" id="discordLink" class="flex items-center justify-center gap-2 py-2.5 bg-[#5865F2] text-white font-black text-[10px] uppercase hover:scale-[1.02] transition-transform">
                                    <i class="fa-brands fa-discord text-[10px]"></i> Discord
                                </a>

                                <div class="flex gap-1">
                                    <a href="#" id="shareX" class="flex-grow flex items-center justify-center py-2 bg-[#111] border border-[#222] text-white transition-all">
                                        <i class="fa-brands fa-x-twitter text-[11px]"></i>
                                    </a>
                                    <a href="#" id="shareFB" class="flex-grow flex items-center justify-center py-2 bg-[#111] border border-[#222] text-white transition-all">
                                        <i class="fa-brands fa-facebook-f text-[11px]"></i>
                                    </a>
                                    <button type="button" id="copyLink" class="flex-grow flex items-center justify-center py-2 bg-[#111] border border-[#222] text-white transition-all">
                                        <i class="fa-solid fa-link text-[11px]"></i>
                                    </button>
                                </div>
                            </div>

                        </div>
                    </div>

                    <div class="overflow-hidden">
                        <button type="button" id="toggleDetailsBtn" class="w-full flex justify-between items-center p-3 bg-[#0d0d0d] transition-all group">
                            <span class="roboto text-[10px] uppercase tracking-[0.3em] font-bold">Submission Details</span>
                            <i class="fa-solid fa-chevron-down text-[10px] transition-transform duration-300" id="chevronIcon"></i>
                        </button>
                        <div id="summaryContent" class="hidden bg-[#050505] p-4 animate-fadeIn"></div>
                    </div>
                </div>
            </div>
            
        </form>
    </div>

    <div class="fixed-social-links-container py-4 z-50 text-center bg-[#0c0c0c]/90 backdrop-blur-sm flex-shrink-0">
        <h2 class="dm-sans text-xs md:text-sm text-white font-bold mb-2">Follow 21 Everywhere</h2>
        <div class="flex justify-center space-x-6 text-xl md:text-2xl">
            <a href="https://discord.gg/av9bpn6Zhp" target="_blank" aria-label="Discord" class="social-link"><i class="fab fa-discord"></i></a>
            <a href="https://www.facebook.com/21xhr" target="_blank" aria-label="Facebook" class="social-link"><i class="fab fa-facebook-f"></i></a>
            <a href="https://www.instagram.com/21xhr_" target="_blank" aria-label="Instagram" class="social-link"><i class="fab fa-instagram"></i></a>
            <a href="https://www.twitch.tv/21xhr" target="_blank" aria-label="Twitch" class="social-link"><i class="fab fa-twitch"></i></a>
            <a href="https://x.com/21xhr" target="_blank" aria-label="X" class="social-link"><i class="fab fa-x-twitter"></i></a>
            <a href="https://www.youtube.com/@21xhr" target="_blank" aria-label="YouTube" class="social-link"><i class="fab fa-youtube"></i></a>
            <a href="https://drummer-manager-website.vercel.app/donation" target="_blank" aria-label="Make a Donation" class="social-link"><i class="fa-solid fa-mug-hot"></i></a>
        </div>
    </div>
</body>
</html>
<script>
    // --- CONFIG ---
    const SESSION_DURATION_MINUTES = 21;
    const BASE_COST_PER_SESSION = 210;
    const LIVE_DISCOUNT_FACTOR = 0.79;
    let submissionToken = '';
    let selectedPlatform = '';
    let selectedPlatformId = '';
    let isStreamLive = false;
    let baseChallengeCost = BASE_COST_PER_SESSION;
    let challengeTextCache = ''; // Cache challenge text for UX

    const DEFAULT_PLACEHOLDER = `Describe the task. (Min 10 chars)
Tip: Use an AI tool like Gemini to help you formulate a clear suggestion!`;

    const RECURRING_PLACEHOLDER = `Describe the task in at least 10 characters.

Use the section below to set the cadence.

Tip: Use a writing assistant to help refine your suggestion.`;

    const ONE_OFF_PLACEHOLDER = `Describe the task in at least 10 characters.

Use the section below to set the total number of 21-minute sessions.

Tip: Use a writing assistant to help refine your suggestion.`;
    
    // Create a new constant for the disabled state to handle line breaks if needed
    const DISABLED_PLACEHOLDER = `Please select a Duration Type above first.`;

   // --- API URL LOGIC (The most robust dual-path) ---
    const getApiBaseUrl = () => {
        const hostname = window.location.hostname;
        
        // 1. If accessed via the Mac's true loopback aliases (localhost, 127.0.0.1, 0.0.0.0), use loopback for API call.
        if (hostname === 'localhost' || hostname === '127.0.0.1' || hostname === '0.0.0.0') {
            return 'http://127.0.0.1:3000/api/v1'; 
        }
        
        // 2. If accessed via the local network IP (i.e., your phone using 192.168.1.37), use that IP.
        if (hostname.startsWith('192.168.')) {
            // Use the IP the form was accessed on, which the phone can reach.
            return `http://${hostname}:3000/api/v1`; 
        }

        // 3. Production fallback
        return 'https://drummer-manager-api.vercel.app/api/v1';
    };

    let API_BASE_URL = getApiBaseUrl(); 
    

    // --- DOM REFERENCES ---
    const form = document.getElementById('challengeForm');
    const formWrapper = document.getElementById('form-wrapper');
    const formTitle = document.getElementById('formTitle');
    const step1 = document.getElementById('step1');
    const statusIcon = document.getElementById('statusIcon');
    const step2 = document.getElementById('step2');
    const step3 = document.getElementById('step3');
    const streamStatusText = document.getElementById('streamStatusText');
    const streamStatusIndicator = document.getElementById('streamStatusIndicator');
    
    const statusMessage1 = document.getElementById('statusMessage1');
    const identityReminder = document.getElementById('identityReminder');
    const reminderUsername = document.getElementById('reminderUsername');
    const reminderPlatform = document.getElementById('reminderPlatform');
    const startNewChallengeButton = document.getElementById('startNewChallengeButton'); 
    
    const durationTypeGroup = document.getElementById('durationTypeGroup');
    const durationCards = formWrapper.querySelectorAll('.duration-card');

    const challengeTextGroup = document.getElementById('challengeTextGroup');
    const challengeEditor = document.getElementById('challengeEditor'); 
    const challengeText = document.getElementById('challengeText');

    const timePaceGroup = document.getElementById('timePaceGroup');
    const currentCostDisplay = document.getElementById('currentCostDisplay');
    const oneOffGroup = document.getElementById('oneOffGroup');
    const totalTimeframeCountInput = document.getElementById('totalTimeframeCount'); 
    const cadenceGroup = document.getElementById('cadenceGroup');
    const cadenceUnitSelect = document.getElementById('cadenceUnit');
    const cadenceCountInput = document.getElementById('cadenceCount');
    const customDaysGroup = document.getElementById('customDaysGroup');
    const customDaysInput = document.getElementById('customDaysCount'); 
    const recurrenceDurationCountInput = document.getElementById('recurrenceDurationCount');
    const timeframeUnitSentenceSpan = document.getElementById('timeframeUnitSentence');
    const cadencePreview = document.getElementById('cadencePreview');
    const sessionCadenceHidden = document.getElementById('sessionCadenceText');
    const calculatedTotalSessionsInput = document.getElementById('calculatedTotalSessions');
    const challengeDurationTypeHidden = document.getElementById('challengeDurationType');
    const durationGroup = document.getElementById('durationGroup');
    const durationLeadInText = document.getElementById('durationLeadInText');
    const submitButton = document.getElementById('submitButton');
    const statusMessage2 = document.getElementById('statusMessage2');
    const calculatedCostInput = document.getElementById('calculatedCost');
    const summaryContent = document.getElementById('summaryContent');
    const shareChallengeButton = document.getElementById('shareChallengeButton');
    const highDemandWarningBanner = document.getElementById('highDemandWarningBanner');
    const highDemandWarningText = document.getElementById('highDemandWarningText');

    // Reference to the 'every X days' option element for UI toggle
    const customDaysOption = document.querySelector('#cadenceUnit option[value="CUSTOM_DAYS"]');

    // --- STEP MANAGEMENT ---
    let currentStep = 1;

    const renderStep = (step) => {
        currentStep = step;
        
        // 1. Toggle visibility of the main steps
        [step1, step2, step3].forEach((el, index) => {
            if (el) el.classList.toggle('hidden', (index + 1) !== step);
        });
        
        // 2. Manage the Identity Reminder visibility
        if (identityReminder) {
            // Only hide on step 1 (verification), show on 2 and 3
            identityReminder.classList.toggle('hidden', step === 1);
        }

        // 3. UI Cleanup when moving back to Step 2
        if (step === 2 && statusMessage2) {
            statusMessage2.textContent = ''; 
        }

        window.scrollTo({ top: 0, behavior: 'smooth' }); 
    };

    const updateStreamButtonText = () => {
        const btnText = document.getElementById('streamBtnText');
        if (!btnText) return; 

        // Use the global boolean 'isStreamLive' set by fetchStreamStatus()
        if (isStreamLive) {
            btnText.innerText = "WATCH STREAM";
        } else {
            btnText.innerText = "WATCH THE LAST STREAM";
        }
    };
    
    // --- TOKEN VERIFICATION LOGIC ---
    const verifyTokenAndStartForm = async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        
        if (!token) {
            statusIcon.classList.remove('fa-spinner', 'fa-spin', 'neon-text');
            statusIcon.classList.add('fa-lock', 'text-red-500');
            statusMessage1.style.color = 'var(--error-red, red)'; // Use a fallback color
            statusMessage1.innerHTML = `
                ACCESS DENIED <br> This page must be accessed via a secure link generated from the stream chat. 
                <br>Please use the command ** !challengesubmit ** in chat to get a valid link.
            `;
            return;
        }

        submissionToken = token;

        // Apply classes for the icon and the spin
        statusIcon.classList.add('fa-spinner', 'fa-spin');
        statusIcon.classList.remove('fa-lock', 'fa-triangle-exclamation', 'fa-hourglass-half', 'fa-circle-check', 'text-success-green', 'text-red-500');
        
        // Use an explicit style property to apply the neon color only, 
        // avoiding the 'fa-spin' conflicting 'neon-text' class.
        statusIcon.style.color = 'var(--primary-neon)'; 
        statusIcon.style.textShadow = '0 0 5px var(--primary-neon)'; // OPTIONAL: Add a soft glow effect 
        
        statusMessage1.style.color = 'var(--text-color)';
        statusMessage1.textContent = 'Verifying your Producer credentials via secure link...';

        try {
            // Enforce a minimum display time for the "Verifying" message
            const MIN_VERIFY_DELAY_MS = 100; 
            
            const apiCall = fetch(`${API_BASE_URL}/token/verify`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: submissionToken })
            });

            // Wait for both the API call to complete AND the minimum delay to pass
            const [response] = await Promise.all([
                apiCall,
                new Promise(resolve => setTimeout(resolve, MIN_VERIFY_DELAY_MS))
            ]);

            // Note: We await the response again to get the JSON data
            const data = await response.json();

            if (response.ok) {
                // Success Logic
                selectedPlatformId = data.username; 
                selectedPlatform = data.platformName;

                reminderUsername.textContent = selectedPlatformId;
                reminderPlatform.textContent = selectedPlatform;
                
                // Apply platform styling to username and platform name
                reminderUsername.className = '';
                reminderPlatform.className = '';
                
                const platformClass = `platform-${selectedPlatform.toLowerCase()}`;
                
                reminderUsername.classList.add(platformClass);
                reminderPlatform.classList.add(platformClass);

                statusIcon.classList.remove('fa-spinner', 'fa-spin', 'neon-text');
                statusIcon.classList.add('fa-circle-check', 'text-success-green');
                statusMessage1.style.color = 'var(--success-green)';
                

                // 2. Success message is displayed with a Delay
                statusMessage1.textContent = `Identity Verified! Submitting as ${selectedPlatformId} on ${selectedPlatform}. Key expires soon.`;

                // Delay for user to read the success message before transition
                setTimeout(() => {
                    renderStep(2); // 3. Enter challenge submission (Step 2)
                    statusMessage1.textContent = ''; 
                    // Call the update function immediately after transitioning to Step 2
                    updateDynamicFields();
                }, 2100); 

            } else if (response.status === 401 || response.status === 400) {
                // TOKEN EXPIRED/INVALID FAILURE
                const apiMessage = data.message || 'The secure link you used is no longer valid. Please get a new token.';
                
                // Determine a concise title from the API error field (if available)
                const title = (data.error && data.error.includes('expired')) 
                    ? 'LINK EXPIRED' 
                    : (data.error && data.error.includes('invalid')) 
                    ? 'LINK INVALID/MALFORMED'
                    : 'AUTHENTICATION FAILED'; // Default
                                 
                statusIcon.classList.remove('fa-spinner', 'fa-spin', 'neon-text');
                statusIcon.classList.add('fa-hourglass-half', 'text-yellow-500'); 
                statusMessage1.style.color = 'var(--primary-neon)';
                
                // Inject the specific error message from the API response
                statusMessage1.innerHTML = `
                    <span class="dm-sans font-bold text-lg">${title}</span>
                    <p class="roboto mt-2 mb-3">
                        ${apiMessage}
                    </p>
                `; // 3. Fall back (Display static error)
            } else {
                // Generic Verification Failure (e.g., 500 server error)
                statusIcon.classList.remove('fa-spinner', 'fa-spin', 'neon-text');
                statusIcon.classList.add('fa-triangle-exclamation', 'text-red-500');
                statusMessage1.style.color = 'var(--error-red, red)';
                statusMessage1.innerHTML = `
                    **Verification Failed!** An unknown server error occurred during verification.
                    <br>Please try again or check the server status.
                `;
            }

        } catch (error) {
            // TRUE NETWORK ERROR (Client cannot physically reach the server)
            statusIcon.classList.remove('fa-spinner', 'fa-spin', 'neon-text');
            statusIcon.classList.add('fa-server', 'text-red-500');
            statusMessage1.style.color = 'var(--error-red, red)';
            statusMessage1.textContent = `CRITICAL ERROR: Could not connect to the API server (${API_BASE_URL}). Check server status.`;
            console.error('Verification Network Error:', error);
        }
    };

    // --- STREAM STATUS & COST LOGIC ---
    const fetchStreamStatus = async () => {
        try {
            const response = await fetch(`${API_BASE_URL}/stream/stats`);
            const data = await response.json();
            
            isStreamLive = data.isStreamLive;
            
            if (isStreamLive) {
                streamStatusIndicator.classList.remove('offline');
                streamStatusIndicator.classList.add('live');
                streamStatusText.textContent = 'LIVE (21% Discount)';
                baseChallengeCost = Math.ceil(BASE_COST_PER_SESSION * LIVE_DISCOUNT_FACTOR);
            } else {
                streamStatusIndicator.classList.remove('live');
                streamStatusIndicator.classList.add('offline');
                streamStatusText.textContent = 'OFFLINE';
                baseChallengeCost = BASE_COST_PER_SESSION;
            }
            // ADD THIS LINE HERE:
            updateStreamButtonText();
        } catch (error) {
            streamStatusText.textContent = 'ERROR';
            console.error('Error fetching stream stats:', error);
            baseChallengeCost = BASE_COST_PER_SESSION; 
        }
        calculateTotalSessions();
    };

    // --- HELPER FUNCTIONS ---
    
    const updateDynamicFields = () => {
        // CRITICAL: Read text length from the contenteditable div's plain text
        const textLength = challengeEditor.textContent.trim().length;
        const durationType = challengeDurationTypeHidden.value;
        const isRecurring = durationType === 'RECURRING';
        const isOneOff = durationType === 'ONE_OFF';

        // Update Placeholder based on selection (via the div's attribute)
        if (isRecurring) {
            challengeEditor.setAttribute('placeholder', RECURRING_PLACEHOLDER);
        } else if (isOneOff) {
            challengeEditor.setAttribute('placeholder', ONE_OFF_PLACEHOLDER);
        } else {
            challengeEditor.setAttribute('placeholder', DEFAULT_PLACEHOLDER);
        }
        

        // Trigger: (Duration Type Selection)
        if (durationType) {
            challengeTextGroup.classList.remove('form-section-disabled');
            // Enable the editor div and the toolbar buttons
            challengeEditor.removeAttribute('disabled');
            document.querySelectorAll('.editor-button').forEach(btn => btn.removeAttribute('disabled'));
            
            // Clear content if the user hasn't typed anything, 
            // ensuring the new CSS placeholder shows correctly.
            if (challengeEditor.textContent.trim().length === 0 || 
                challengeEditor.innerHTML.trim() === '<br>') { // Check for empty or just a line break
                challengeEditor.innerHTML = ''; 
            }
            
        } else {
            challengeTextGroup.classList.add('form-section-disabled');
            // Disable the editor div and the toolbar buttons
            challengeEditor.setAttribute('disabled', 'true');
            document.querySelectorAll('.editor-button').forEach(btn => btn.setAttribute('disabled', 'true'));
            
            // Set the specific disabled placeholder on the DIV
            challengeEditor.setAttribute('placeholder', DISABLED_PLACEHOLDER);
            
            // When the editor is disabled, ensure the content is empty 
            // so the disabled placeholder shows immediately.
            challengeEditor.innerHTML = '';
        }

        // Trigger: Enable Time/Pace after sufficient challenge text is entered
        const canSetPace = durationType && textLength >= 10;
        
        if (canSetPace) {
            timePaceGroup.classList.remove('form-section-disabled');
            totalTimeframeCountInput.disabled = false;
            cadenceCountInput.disabled = false;
            cadenceUnitSelect.disabled = false;
            customDaysInput.disabled = false;
            recurrenceDurationCountInput.disabled = false;
            
            oneOffGroup.classList.toggle('hidden', !isOneOff);
            cadenceGroup.classList.toggle('hidden', !isRecurring);
            
            // Set default for recurring if not set
            if (isRecurring && !cadenceUnitSelect.value) {
                cadenceUnitSelect.value = 'DAILY';
                // Trigger the full reset if we had to set the default
                setCadenceTimeframeDefaults(cadenceUnitSelect.value); // This runs the first calculation
            }
            
        } else {
            timePaceGroup.classList.add('form-section-disabled');
            totalTimeframeCountInput.disabled = true;
            cadenceCountInput.disabled = true;
            cadenceUnitSelect.disabled = true;
            customDaysInput.disabled = true;
            recurrenceDurationCountInput.disabled = true;
            
            // Reset cost displays if sections are disabled
            const oneOffDisplay = document.getElementById('oneOffCostDisplay');
            const recurringDisplay = document.getElementById('recurringCostDisplay');
            if (oneOffDisplay) oneOffDisplay.textContent = '--';
            if (recurringDisplay) recurringDisplay.textContent = '--';

            cadencePreview.textContent = '...';
        }

        // CRITICAL: Ensure calculation runs BEFORE the submit check
        calculateTotalSessions();
        
        // Update submit button state
        const hasChallengeText = textLength >= 10;
        const hasDurationSelection = !!durationType;
        let hasSessions = false;
        
        // Ensure total sessions is calculated and >= 1. For recurring, ensure >= 2.
        const totalSessions = parseInt(calculatedTotalSessionsInput.value);
        if (totalSessions >= 1) { 
             // For Recurring, enforce a total of at least 2 sessions to be valid
             if (isRecurring && totalSessions < 2) {
                 hasSessions = false; 
             } else {
                hasSessions = true;
             }
        }
        
        submitButton.disabled = !(hasChallengeText && hasDurationSelection && hasSessions);

        // Manually toggle the subtext visibility based on button state
        const btnSubtext = document.getElementById('btnSubtext');
        if (btnSubtext) {
            btnSubtext.style.opacity = submitButton.disabled ? "0" : "1";
        }

        // --- Call Warning Checker ---
        checkHighDemandWarning();
    };

    const setCadenceTimeframeDefaults = (unit) => {
        // Only set this up when recurring is active
        if (challengeDurationTypeHidden.value !== 'RECURRING') return;
        
        // --- UI: Manage visibility and text of the 'every X days' option ---
        if (customDaysOption) {
            if (unit === 'CUSTOM_DAYS') {
                // 1. Hide the option from the list
                customDaysOption.style.display = 'none';
                // 2. Clear the displayed text in the closed dropdown box to avoid redundancy
                customDaysOption.textContent = ' '; 
            } else {
                // 1. Show the option when any other unit is selected
                customDaysOption.style.display = 'block'; 
                // 2. Restore the original text
                customDaysOption.textContent = 'every X days'; 
            }
        }

        // IMPORTANT: Reset to preferred minimums when changing unit
        cadenceCountInput.value = '1'; 
        recurrenceDurationCountInput.value = '2';
        
        // This is only for display purposes in the sentence
        if (unit === 'DAILY') {
            timeframeUnitSentenceSpan.textContent = "Days";
        } else if (unit === 'WEEKLY') {
            timeframeUnitSentenceSpan.textContent = "Weeks";
        } else if (unit === 'MONTHLY') {
            timeframeUnitSentenceSpan.textContent = "Months";
        } else if (unit === 'CUSTOM_DAYS') {
            timeframeUnitSentenceSpan.textContent = "times";
        }

        customDaysGroup.classList.toggle('hidden', unit !== 'CUSTOM_DAYS');
        
        // We always call calculateTotalSessions to ensure all fields are updated
        calculateTotalSessions();
    };
    
    const calculateTotalSessions = () => {
        const durationType = challengeDurationTypeHidden.value;

        let text = "";
        let calculatedTotal = 0;
        
        if (durationType === 'ONE_OFF') {
            calculatedTotal = Math.min(parseInt(totalTimeframeCountInput.value) || 1, 999);
            // Ensure minimum of 1 session for one-off
            if (calculatedTotal < 1) calculatedTotal = 1;
            totalTimeframeCountInput.value = calculatedTotal;
            text = `ONE_OFF: ${calculatedTotal} session(s).`;
            
        } else if (durationType === 'RECURRING') { 
            const unit = cadenceUnitSelect.value;
            // Get user inputs, default to 1
            let pace = Math.min(parseInt(cadenceCountInput.value) || 1, 999);
            let timeframeCount = Math.min(parseInt(recurrenceDurationCountInput.value) || 1, 999); 
            const customDays = parseInt(customDaysInput.value) || 1;
            
            // --- Show durationGroup if a unit is selected and parent section is enabled ---
            if (unit && !timePaceGroup.classList.contains('form-section-disabled')) {
                durationGroup.classList.remove('hidden');
            }

            // --- CRITICAL: Minimums based on unit type ---
            if (unit === 'DAILY' || unit === 'CUSTOM_DAYS') {
                
                if (pace < 1) pace = 1; // Enforce minimum pace of 1
                
                // Enforce minimum duration of 2 units (days/times) for recurrence
                if (timeframeCount < 2) {
                    timeframeCount = 2; 
                }
                
            } else if (unit === 'WEEKLY' || unit === 'MONTHLY') {
                
                if (pace < 1) pace = 1; // Allow minimum pace of 1 session per week/month
                if (timeframeCount < 1) timeframeCount = 1; // Enforce minimum duration of 1 unit
                
                // If pace is 1, duration must be at least 2 units to ensure 2 total sessions
                if (pace === 1 && timeframeCount < 2) {
                    timeframeCount = 2;
                }
                
            }
            
            // 2. Update DOM fields with enforced minimums
            cadenceCountInput.value = pace;
            recurrenceDurationCountInput.value = timeframeCount;
            // --- End Enforcement ---

            calculatedTotal = pace * timeframeCount;
            
            if (!unit) {
                // If cadenceUnit is not selected yet
                text = "Select a frequency and duration to calculate total sessions.";
                calculatedTotal = 0;
                durationGroup.classList.add('hidden'); // Ensure it hides if unit is reset
            } else {
                
                // --- GRAMMAR FIXES ---
                const paceText = pace === 1 ? 'session' : 'sessions';
                let unitDisplay = unit.toLowerCase();
                
                // Map 'daily', 'weekly', 'monthly' to 'day', 'week', 'month'
                if (unitDisplay === 'daily') unitDisplay = 'day';
                else if (unitDisplay === 'weekly') unitDisplay = 'week';
                else if (unitDisplay === 'monthly') unitDisplay = 'month';
                
                const timeframeUnit = timeframeUnitSentenceSpan.textContent.toLowerCase(); // Fix capitalization

                if (unit === 'DAILY' || unit === 'WEEKLY' || unit === 'MONTHLY') {
                    // e.g., "1 session per day for 2 days"
                    text = `${pace} ${paceText} per ${unitDisplay} for ${timeframeCount} ${timeframeUnit}`;
                } else if (unit === 'CUSTOM_DAYS') {
                    // e.g., "1 session every 3 days for 4 times"
                    text = `${pace} ${paceText} every ${customDays} days for ${timeframeCount} times`;
                }
            }

            // Removed: redundant "= X Total Sessions" part
            durationLeadInText.textContent = unit === 'CUSTOM_DAYS' ? "then repeat this" : "for a total of";
        } else {
            text = "Select a Duration Type to continue.";
            calculatedTotal = 0;
        }
        
        const totalMinutes = calculatedTotal * SESSION_DURATION_MINUTES;
        const finalCost = baseChallengeCost;

        calculatedTotalSessionsInput.value = calculatedTotal;
        sessionCadenceHidden.value = text;
        calculatedCostInput.value = finalCost;
        
        // Implementation: Display total sessions/minutes correctly for the active duration type
        const totalSessionsDisplay = `${calculatedTotal.toLocaleString()} sessions (${totalMinutes.toLocaleString()} Mins)`;
        
        // 3. Update One-Off Summary element if visible (uses the new HTML element)
        const oneOffSummary = document.getElementById('oneOffSummary');
        if (oneOffSummary && durationType === 'ONE_OFF') {
             oneOffSummary.textContent = `(${totalMinutes.toLocaleString()} Mins)`;
        }

        // 4. Update Recurring/General Summary element if visible
        cadencePreview.textContent = totalSessionsDisplay; 
        
        // --- Define formattedCost here ---
        const formattedCost = finalCost.toLocaleString();

        // Update both cost displays 
        const oneOffDisplay = document.getElementById('oneOffCostDisplay');
        const recurringDisplay = document.getElementById('recurringCostDisplay');
        
        if (oneOffDisplay) oneOffDisplay.textContent = formattedCost;
        if (recurringDisplay) recurringDisplay.textContent = formattedCost;

        // --- PLURALIZATION LOGIC ---
        const oneOffPluralizer = document.getElementById('oneOffSessionPluralization');
        if (oneOffPluralizer && durationType === 'ONE_OFF') {
            const currentCount = parseInt(totalTimeframeCountInput.value) || 0;
            oneOffPluralizer.textContent = currentCount === 1 ? 'Session' : 'Sessions';
        }
    };

    
    // --- WARNING LOGIC IMPLEMENTATION ---
    const checkHighDemandWarning = () => {
        const durationType = challengeDurationTypeHidden.value;
        const totalSessions = parseInt(calculatedTotalSessionsInput.value) || 0;
        
        let shouldShowWarning = false;
        let sessionsPerPeriod = 0;
        let periodText = '';
        
        // Constants for thresholds (Self-documenting and easy to adjust)
        const ONE_OFF_MAX_SESSIONS = 7; 
        const RECURRING_THRESHOLDS = {
            'DAILY': 7,
            'WEEKLY': 42,
            'MONTHLY': 147,
        };

        // If no duration is selected, hide and exit
        if (!durationType) {
            highDemandWarningBanner.classList.add('hidden');
            return;
        }

        // 1. ONE-OFF CHALLENGE LOGIC
        if (durationType === 'ONE_OFF') {
            if (totalSessions > ONE_OFF_MAX_SESSIONS) {
                shouldShowWarning = true;
                sessionsPerPeriod = totalSessions; 
                periodText = 'Single Challenge Day';
            }
        }
        
        // 2. RECURRING CHALLENGE LOGIC
        else if (durationType === 'RECURRING') {
            const unit = cadenceUnitSelect.value;
            const pace = parseInt(cadenceCountInput.value) || 0;
            
            if (unit === 'DAILY') {
                sessionsPerPeriod = pace;
                periodText = 'Day';
                if (pace > RECURRING_THRESHOLDS.DAILY) shouldShowWarning = true;
                
            } else if (unit === 'WEEKLY' || unit === 'MONTHLY') {
                sessionsPerPeriod = pace;
                // Use the display text from the global variable (Days, Weeks, Months)
                periodText = timeframeUnitSentenceSpan.textContent.slice(0, -1); 
                
                if (unit === 'WEEKLY' && pace > RECURRING_THRESHOLDS.WEEKLY) shouldShowWarning = true;
                if (unit === 'MONTHLY' && pace > RECURRING_THRESHOLDS.MONTHLY) shouldShowWarning = true;

            } else if (unit === 'CUSTOM_DAYS') {
                const customDays = parseInt(customDaysInput.value) || 1;
                // Normalized check: Average daily pace must be > 7 sessions/day
                const averageDailyPace = pace / customDays; 
                
                sessionsPerPeriod = pace; 
                periodText = ` ${customDays} Day cycle`;
                
                // Check against the DAILY threshold for the average pace
                if (averageDailyPace > RECURRING_THRESHOLDS.DAILY) {
                    shouldShowWarning = true;
                }
            }
        }
        
        // 3. UI UPDATE (Runs only if a warning was triggered in step 1 or 2)
        if (shouldShowWarning) {
            highDemandWarningText.innerHTML = `This submission requires <strong>${sessionsPerPeriod} session(s) per ${periodText}</strong>, which far exceeds the normal demand threshold. If activated, it will rapidly monopolize the execution slot for an extended duration.`;
            highDemandWarningBanner.classList.remove('hidden');
        } else {
            highDemandWarningBanner.classList.add('hidden');
        }
    };


    const generateChallengeSummary = (challenge, cost, userStats) => {
        if (!challenge || !userStats) return `<p>Error</p>`;

        const isRecurring = challenge.durationType === 'RECURRING';
        
        // Update the Global Share Link
        const challengeUrl = `https://drummer-manager-website.vercel.app/`; 
        const shareText = encodeURIComponent(`ü•Å Challenge #${challenge.challengeId} logged to @21xhr!\nCost: ${cost.toLocaleString()} NUMBERS\n#DrummerManager`);
        const twitterIntent = `https://x.com/intent/tweet?text=${shareText}&url=${encodeURIComponent(challengeUrl)}`;

        // 1. Update the 'shareX' button (the one in your HTML)
        const xButton = document.getElementById('shareX');
        if (xButton) {
            xButton.href = twitterIntent;
        }

        // 2. Safety check for the 'shareChallengeButton' variable if used elsewhere
        if (typeof shareChallengeButton !== 'undefined' && shareChallengeButton) {
            shareChallengeButton.href = twitterIntent;
        }

        // 1. ADD THIS SAFETY LOGIC HERE
        const durationType = challenge?.durationType || 'ONE_OFF';
        
        // Helper 1: Handles the unit name mapping
        const getUnitName = (unit) => {
            const map = { 'DAILY': 'day', 'WEEKLY': 'week', 'MONTHLY': 'month' };
            return map[unit] || 'day';
        };

        // Helper 2: Adds 's' if count is NOT 1
        const plural = (count, word) => {
            if (!word) return '';
            const cleanWord = word.replace(/s$/i, ''); // Strip existing 's' to prevent "Weekss"
            return count === 1 ? cleanWord : `${cleanWord}s`;
        };

        // 1. Determine the Base Unit (Day, Week, Month)
        let unitLabel = 'day'; 
        if (challenge.cadenceUnit === 'WEEKLY') unitLabel = 'week';
        if (challenge.cadenceUnit === 'MONTHLY') unitLabel = 'month';
        // For CUSTOM_DAYS, the unit is always 'day'

        // 2. Use the ACTUAL count from the challenge object
        const totalTimeframeValue = challenge.recurrenceDurationCount || 1;

        // 3. Pluralize correctly
        const timeUnitPlural = plural(totalTimeframeValue, unitLabel);

        const cadenceDetail = durationType === 'RECURRING' 
            ? (challenge.sessionCadenceText || "Recurring mission")
            : "Single session mission";

        return `
            <div class="space-y-4 animate-fadeIn">
                <div class="flex justify-between border-b border-[#333] pb-2 items-center">
                    <div>
                        <div class="summary-label text-[9px] uppercase font-bold tracking-widest" style="color: var(--subtext-color)">Challenge ID</div>
                        <div class="summary-value text-lg font-black text-white">#${challenge.challengeId}</div>
                    </div>
                    <div class="text-center">
                        <div class="summary-label text-[9px] uppercase font-bold tracking-widest" style="color: var(--subtext-color)">Cost</div>
                        <div class="summary-value text-lg font-black text-primary-neon">${cost.toLocaleString()} <span class="text-[9px]">NUMBERS</span></div>
                    </div>
                    <div class="text-right">
                        <div class="summary-label text-[8px] mb-0.5" style="color: var(--subtext-color)">TYPE</div>
                        <div class="text-[11px] font-bold text-gray-200 uppercase">${durationType.replace('_', ' ')}</div>
                    </div>
                </div>
                
                <div class="flex justify-between items-stretch gap-2">
                    <div class="flex-1 p-3 rounded-lg border border-[#222] flex flex-col justify-center items-center text-center bg-gradient-to-br from-[#0a0a0a] to-[#111]">
                        <div class="summary-label text-[8px] mb-1" style="color: var(--subtext-color)">SESSIONS</div>
                        <div class="text-[11px] font-bold text-gray-200">${challenge.totalSessions} Total</div>
                    </div>

                    <div class="flex-[1.5] p-3 rounded-lg border border-[#1a1a1a] flex flex-col justify-center text-right bg-gradient-to-br from-[#0a0a0a] to-[#111]">
                        <div class="summary-label text-[8px] mb-1" style="color: var(--subtext-color)">TIMELINE & PACING</div>
                        <div class="text-[11px] text-gray-300 roboto tracking-wide">
                            ${cadenceDetail} <i class="fa-solid fa-calendar-check text-primary-neon ml-1"></i>
                        </div>
                    </div>
                </div>

                <div class="pt-1">
                    <div class="summary-label text-[8px] mb-1" style="color: var(--subtext-color) border-l-2">DESCRIPTION</div>
                    <div class="summary-scroll-box roboto text-[13px] leading-relaxed italic border-l-2 border-primary-neon pl-3 py-2 bg-[#000]">
                        "${challenge.challengeText}"
                    </div>
                </div>

                <div class="flex justify-between items-center pt-2 border-t border-[#222]">
                    <div class="summary-label text-[9px] text-white font-bold uppercase">New Balance</div>
                    <div class="text-sm text-white">${userStats.currentBalance.toLocaleString()} <span class="text-[9px] text-primary-neon">NUMBERS</span></div>
                </div>
            </div>
        `;
    };

    const resetForm = () => {
        // --- Reset internal UI state instead of hard reload ---
        form.reset();
        
        if (statusMessage2) {
            statusMessage2.textContent = '';
            statusMessage2.className = 'roboto text-sm text-center mt-3'; // Reset to base classes
        }
        
        // Clear the visual editor if it exists
        if (typeof challengeEditor !== 'undefined' && challengeEditor) {
            challengeEditor.innerHTML = '';
        }

        // Clean up classes
        challengeDurationTypeHidden.value = '';
        durationCards.forEach(card => card.classList.remove('selected'));
        challengeTextGroup.classList.add('form-section-disabled');
        timePaceGroup.classList.add('form-section-disabled');
        oneOffGroup.classList.add('hidden');
        cadenceGroup.classList.add('hidden');
        submitButton.disabled = true;
        const container = document.querySelector('.form-container');
        if (container) container.classList.remove('boosted-neon-border-pulse');

        // --- INSTEAD OF window.location.href ---
        // Just move the user back to the verification step 
        // This keeps the Live Server connection active!
        if (typeof renderStep === 'function') {
            renderStep(1); 
            // Re-run verification to ensure token is still valid
            verifyTokenAndStartForm(); 
        } else {
            // Fallback only if renderStep is missing
            window.location.reload();
        }
    };

    // --- EVENT LISTENERS ---

    fetchStreamStatus();
    verifyTokenAndStartForm();
    handleCopyLink();
    handleSocialFeedback();
    
    // Step 2: Duration Card Selection (Trigger 1)
    const playlist = [
        "../assets/audio/Glass Rivers by 21_2.mp3",
        "../assets/audio/Glass Rivers by 21.mp3",
        "../assets/audio/Neon Artery by 21_2.mp3",
        "../assets/audio/Neon Artery by 21.mp3",
        "../assets/audio/Rain On The Window by 21_2.mp3",
        "../assets/audio/Rain On The Window by 21.mp3",
        "../assets/audio/Rite of the Iron Colossus by 21_2.mp3",
        "../assets/audio/Rite of the Iron Colossus by 21.mp3",
        "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-10.mp3",
        "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-17.mp3",
        "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3",
        "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3"
    ];

    // Randomize the starting track on page load
    let currentTrack = Math.floor(Math.random() * playlist.length);
    //let currentTrack = 0; // Start from the first track for consistency

    const bgMusic = document.getElementById('bgMusic');
    const muteToggle = document.getElementById('muteToggle');
    const muteIcon = document.getElementById('muteIcon');

    if (muteToggle && bgMusic) {
        muteToggle.addEventListener('click', () => {
            bgMusic.muted = !bgMusic.muted;
            // Toggle icon and color
            if (bgMusic.muted) {
                muteIcon.className = 'fa-solid fa-volume-xmark text-[10px]';
                muteIcon.style.color = '#666';
            } else {
                muteIcon.className = 'fa-solid fa-volume-high text-[10px]';
                muteIcon.style.color = 'var(--primary-neon)';
            }
        });
    }

    // Handle switching to the next song
    const playNextSong = () => {
        currentTrack = (currentTrack + 1) % playlist.length;
        bgMusic.src = playlist[currentTrack];
        bgMusic.play().catch(e => console.log("Playback interrupted"));
    };

    // Listen for when a song ends to play the next one automatically
    if (bgMusic) {
        bgMusic.addEventListener('ended', playNextSong);
    }
    
    durationCards.forEach(card => {
        card.addEventListener('click', () => {
            if (bgMusic && bgMusic.paused) {
                // Only set the source if it hasn't been set yet
                if (!bgMusic.src) {
                    bgMusic.src = playlist[currentTrack];
                }
                bgMusic.volume = 0.2; 
                bgMusic.play().catch(e => console.log("Audio blocked"));
            }
            const type = card.getAttribute('data-duration');
            
            challengeTextCache = challengeText.value;

            durationCards.forEach(btn => btn.classList.remove('selected'));
            card.classList.add('selected');
            
            challengeDurationTypeHidden.value = type;

            challengeText.value = challengeTextCache;
            
            challengeTextGroup.classList.remove('form-section-disabled');
            challengeText.disabled = false;

            if (type === 'RECURRING') {
                if (!cadenceUnitSelect.value) {
                    cadenceUnitSelect.value = 'DAILY';
                }
                // DEFAULTS: 1 session per unit, for 2 units total (ensures minimum recurrence)
                cadenceCountInput.value = '1'; 
                recurrenceDurationCountInput.value = '2'; 
                
                setCadenceTimeframeDefaults(cadenceUnitSelect.value); // This runs calculation
            } else if (type === 'ONE_OFF') {
                if (totalTimeframeCountInput.value === '0') {
                    totalTimeframeCountInput.value = '1';
                }
            }
            
            updateDynamicFields(); 
        });
    });

    // Step 2: Challenge Text Input (Trigger 2)
    challengeText.addEventListener('input', () => {
        challengeTextCache = challengeText.value;
        updateDynamicFields();
    });

    // Step 2: Cadence/Session logic
    cadenceUnitSelect.addEventListener('change', (e) => {
        setCadenceTimeframeDefaults(e.target.value); 
    });
    // Input changes calls the update function
    cadenceCountInput.addEventListener('input', updateDynamicFields);
    customDaysInput.addEventListener('input', updateDynamicFields);
    recurrenceDurationCountInput.addEventListener('input', updateDynamicFields); 
    totalTimeframeCountInput.addEventListener('input', updateDynamicFields);
    
    // Step 2: Form Submission
    form.addEventListener('submit', async (e) => { 
        e.preventDefault();
        
        if (!submissionToken) { 
            statusMessage2.style.color = 'var(--error-red)';
            statusMessage2.textContent = 'Error: Session key expired or missing. Please refresh the page.';
            return; 
        }
        
        // 0. CAPTURE ORIGINAL STATE
        const originalBtnText = submitButton.innerHTML;

        // 1. GHOST THE FORM CONTENT
        const formFields = document.querySelectorAll('#step2 > div:not(.submit-row-container)'); 
        formFields.forEach(field => field.classList.add('form-content-fade'));

        // 2. HERO BUTTON STATUS
        submitButton.disabled = true;
        submitButton.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> TRANSMITTING...';
        statusMessage2.textContent = '';

        const submissionData = {
            token: submissionToken,
            challengeText: challengeText.value,
            totalSessions: parseInt(calculatedTotalSessionsInput.value),
            durationType: challengeDurationTypeHidden.value,
            cost: parseInt(calculatedCostInput.value),
            cadenceUnit: (challengeDurationTypeHidden.value === 'RECURRING' ? cadenceUnitSelect.value : undefined),
            sessionCadenceText: (challengeDurationTypeHidden.value === 'RECURRING' ? sessionCadenceHidden.value : undefined)
        };

        try {
            const response = await fetch(`${API_BASE_URL}/user/submit/web`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(submissionData)
            });

            const data = await response.json();

            if (response.ok) {
                // 1. Success Feedback
                submitButton.innerHTML = '<i class="fa-solid fa-circle-check"></i> RECEIVED';
                
                // 2. CALCULATE CENTER
                const container = document.querySelector('.form-container');
                const btnRect = submitButton.getBoundingClientRect();
                const containerRect = container.getBoundingClientRect();

                // Calculate the distance from the button's current center to the container's center
                const btnCenterY = btnRect.top + btnRect.height / 2;
                const containerCenterY = containerRect.top + containerRect.height / 2;
                const travelDistance = containerCenterY - btnCenterY;

                // Set the CSS variable so the animation knows where to go
                submitButton.style.setProperty('--travel-distance', `${travelDistance}px`);
                
                // 3. START TRANSLATION
                // Small timeout to ensure the CSS variable is registered
                setTimeout(() => {
                    submitButton.classList.add('button-hero-transition');
                }, 10);

                const { newChallenge, cost, userStats } = data.details;
                summaryContent.innerHTML = generateChallengeSummary(newChallenge, cost, userStats);

                // 4. THE POP & REVEAL (Synchronized)
                setTimeout(() => {
                    // Start shrinking the button
                    submitButton.classList.add('button-pop-out');
                    
                    // START STEP 3 ALMOST IMMEDIATELY (Don't wait for button to be 100% gone)
                    setTimeout(() => {
                        const step2 = document.getElementById('step2');
                        if (step2) step2.classList.add('hidden');
                        
                        renderStep(3); // Step 3's animate-fadeIn starts NOW
                        
                        const container = document.querySelector('.form-container');
                        container.style.height = 'auto'; 

                        // Cleanup in the background
                        submitButton.classList.remove('button-hero-transition', 'button-pop-out');
                        submitButton.style.removeProperty('--travel-distance');
                        formFields.forEach(field => field.classList.remove('form-content-fade'));
                        submitButton.style.backgroundColor = ''; 
                        submitButton.innerHTML = originalBtnText;
                        submitButton.disabled = false;
                        
                        handleSocialFeedback();
                        handleCopyLink();
                    }, 150); // Only a 150ms gap feels like a "hand-off" rather than a wait
                }, 2100); // Time spent the center instead of the container 
            } else {
                // Server Error (e.g. 400 or 500)
                formFields.forEach(field => field.classList.remove('form-content-fade'));
                statusMessage2.style.color = 'var(--error-red)';
                statusMessage2.textContent = `Error: ${data.message || 'Request Denied'}`;
                submitButton.disabled = false;
                submitButton.innerHTML = originalBtnText;
            }
        } catch (error) {
            formFields.forEach(field => field.classList.remove('form-content-fade'));
            console.error('Submission Network Error:', error);
            statusMessage2.style.color = 'var(--error-red)';
            statusMessage2.textContent = `COMMUNICATIONS FAILURE: Check your connection.`;
            submitButton.disabled = false;
            submitButton.innerHTML = originalBtnText;
        }
    });

    // --- WYSIWYG EDITOR LOGIC ---
    const updateHiddenChallengeText = () => {
        let content = challengeEditor.innerHTML.trim();
        const plainText = challengeEditor.textContent.trim();
        
        if (plainText.length === 0) {
            if (content === '<br>') {
                content = '';
                challengeEditor.innerHTML = ''; 
            }
            if (content.length === 0) {
                challengeEditor.innerHTML = '';
            }
        }
        challengeText.value = content; 
        return plainText.length;
    };
    
    const execCommand = (command, value = null) => {
        challengeEditor.focus();
        try {
            document.execCommand(command, false, value);
        } catch (error) {
            console.error(`execCommand failed for ${command}:`, error);
        }
        updateDynamicFields(); 
    };

    const toggleBtn = document.getElementById('toggleDetailsBtn');
    const summaryBox = document.getElementById('summaryContent');
    const chevron = document.getElementById('chevronIcon');

    if (toggleBtn) {
        toggleBtn.addEventListener('click', () => {
            const isHidden = summaryBox.classList.contains('hidden');
            summaryBox.classList.toggle('hidden');
            chevron.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';
            if (isHidden) {
                setTimeout(() => {
                    summaryBox.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 50);
            }
        });
    }

    // Function to handle copying the link with feedback
    function handleCopyLink() {
        // Look for the button again to ensure we have the current DOM element
        const copyBtn = document.getElementById('copyLink');
        if (!copyBtn) {
            console.warn("Copy button not found in DOM yet.");
            return;
        }

        // Use addEventListener instead of onclick to prevent overwriting issues
        // Remove old one first to avoid double-firing
        copyBtn.replaceWith(copyBtn.cloneNode(true)); 
        const newBtn = document.getElementById('copyLink');

        newBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();

            const textToCopy = window.location.origin; 

            // Reliable Copy Logic
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(textToCopy);
            } else {
                const textArea = document.createElement("textarea");
                textArea.value = textToCopy;
                textArea.style.position = "fixed";
                textArea.style.left = "-9999px";
                textArea.style.top = "0";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
            }

            // FEEDBACK: Keep the 'copied' class for the grayscale effect
            this.classList.add('copied');

            // Badge Creation (This is the only thing the user actually sees now!)
            const badge = document.createElement('span');
            badge.className = 'copy-badge roboto';
            badge.innerText = 'Copied!';
            this.appendChild(badge);

            setTimeout(() => {
                this.classList.remove('copied');
                if (badge.parentNode) badge.remove();
            }, 2100);
        });
    }

    function handleSocialFeedback() {
        ['shareX', 'shareFB'].forEach(id => {
            const btn = document.getElementById(id);
            if (!btn) return;
            btn.onclick = function() {
                const badge = document.createElement('span');
                badge.className = 'copy-badge roboto';
                badge.innerText = 'LFG...';
                badge.style.background = 'var(--primary-neon)'; // Stays neon yellow
                this.appendChild(badge);
                setTimeout(() => { if (badge.parentNode) badge.remove(); }, 2100);
            };
        });
    }

    // Toolbar button listeners
    document.querySelectorAll('.editor-button').forEach(button => {
        button.addEventListener('click', (e) => {
            e.preventDefault(); 
            const command = button.getAttribute('data-edit');
            execCommand(command);
        });
    });

    // Update the hidden input and check validation on content change
    challengeEditor.addEventListener('input', () => {
        updateHiddenChallengeText(); 
        updateDynamicFields(); 
    });

    startNewChallengeButton.addEventListener('click', function() {
        const icon = this.querySelector('i');

        icon.classList.add('icon-active-pulse');
        icon.style.color = "var(--primary-neon)";

        // Wait for the graceful discharge
        setTimeout(() => {
            resetForm();
            // Reset for the next round
            this.style.pointerEvents = "auto";
            icon.classList.remove('icon-active-pulse');
            icon.style.color = "";
        }, 1200); 
    });
</script>