<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Challenge Submission Form</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="../styles.css"> 
    
    <style>
        /* Only keep necessary utility styles */
        .hidden { display: none !important; }
        
        /* ⭐ MOBILE FIX: Add small padding to body to prevent form edge clipping on smaller screens ⭐ */
        body { 
            padding: 1rem; /* Adjust from 2rem to 1rem for tight fit */
        }
    </style>
</head>
<body class="dm-sans"> 
    <div class="form-container">
        <h1 class="dm-sans text-3xl font-bold text-center neon-text">
            New Challenge Submission
        </h1>
        <p class="roboto text-center text-sm text-gray-400">
            This form simulates the secure, two-step challenge submission process.
        </p>
    
        <form id="challengeForm">
            <h2 class="form-heading">1. User Authentication (Step 1: Get Token)</h2>
            
            <div class="form-group">
                <label for="platformId">Platform ID (Your Username):</label>
                <input type="text" id="platformId" class="form-input" placeholder="e.g., DrummerBoy21" required>
            </div>

            <div class="form-group">
                <label for="platformName">Platform Name:</label>
                <select id="platformName" class="form-input" required>
                    <option value="" disabled selected>The Streaming Platform You Came From</option>
                    <option value="KICK">Kick</option>
                    <option value="TWITCH">Twitch</option>
                    <option value="YOUTUBE">Youtube</option>
                    </select>
            </div>

            <div class="form-group">
                <label for="duration">Token Duration (Optional):</label>
                <input type="text" id="duration" class="form-input" placeholder="This is totally optional">
            </div>

            <button type="button" id="getTokenButton" class="interactive-button form-button">
                Get Submission Token
            </button>
    
            <div id="formFields" class="hidden">
                <h2 class="form-heading">2. Challenge Details (Step 2: Submit)</h2>
                <p class="roboto text-sm">
                    Token Status: <strong id="tokenStatus" style="color: var(--primary-neon);">Awaiting Token</strong>
                </p>
    
                <div class="form-group">
                    <label for="challengeText">Challenge Text:</label>
                    <textarea id="challengeText" class="form-input" placeholder="Briefly describe the challenge (e.g., Play a fill using only triplets, Do a solo with one hand tied)." required></textarea>
                </div>
    
                <div class="form-group">
                    <label for="durationType">Duration Type:</label>
                    <select id="durationType" class="form-input" required>
                        <option value="ONE_OFF">ONE_OFF (Single Session)</option>
                        <option value="RECURRING">RECURRING (Multiple Sessions)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="totalSessions">Total Sessions (Min 1):</label>
                    <input type="number" id="totalSessions" class="form-input" min="1" value="7" required>
                </div>
                
                <div id="cadenceGroup" class="hidden form-group">
                    <label for="cadence">Cadence (Required for RECURRING):</label>
                    <input type="text" id="cadence" class="form-input" placeholder="e.g., Weekly, Daily, Every 3 days">
                </div>
    
                <button type="submit" class="interactive-button form-button">
                    Submit Challenge
                </button>
            </div>
        </form>
    
        <h2 class="form-heading">Output</h2>
        <div id="output" class="roboto"></div>
    </div>

    <script>
        // --- Dynamic API URL Configuration (Professional Local/Prod Switch) ---
        const getApiBaseUrl = () => {
            // 1. Check if the current hostname is a known local development address.
            const isLocal = window.location.hostname === 'localhost' || 
                            window.location.hostname === '127.0.0.1' ||
                            // Including the local IP addresses for robustness.
                            window.location.hostname.startsWith('192.168.1.'); 
            
            // 2. If running locally, return the reliable loopback address.
            if (isLocal) {
                return 'http://localhost:3000/api/v1'; 
            }

           // 3. Otherwise, assume production/live environment and use the Vercel API domain.
            return 'https://drummer-manager-api.vercel.app/api/v1';
        };
        const API_BASE_URL = getApiBaseUrl();

        const form = document.getElementById('challengeForm');
        const getTokenButton = document.getElementById('getTokenButton');
        const outputDiv = document.getElementById('output');
        const formFieldsDiv = document.getElementById('formFields');
        const tokenStatusStrong = document.getElementById('tokenStatus');
        const durationTypeSelect = document.getElementById('durationType');
        const cadenceGroup = document.getElementById('cadenceGroup');
        const cadenceInput = document.getElementById('cadence');

        let submissionToken = '';

        // --- UI Logic for Cadence Field ---
        durationTypeSelect.addEventListener('change', (e) => {
            const isRecurring = e.target.value === 'RECURRING';
            cadenceGroup.classList.toggle('hidden', !isRecurring);
            cadenceInput.required = isRecurring;
        });

        // --- Step 1: Get Token ---
        getTokenButton.addEventListener('click', async () => {
            const platformId = document.getElementById('platformId').value;
            const platformName = document.getElementById('platformName').value;
            // The duration field is now optional
            const duration = document.getElementById('duration').value || undefined; 

            if (!platformId || !platformName) {
                outputDiv.textContent = 'Error: Platform ID and Name are required.';
                return;
            }

            outputDiv.textContent = 'Requesting token...';

            try {
                const response = await fetch(`${API_BASE_URL}/token/submit-challenge`, { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    // Only send duration if it's not undefined (i.e., user entered a value)
                    body: JSON.stringify({ platformId, platformName, duration })
                });

                const data = await response.json();

                if (response.ok) {
                    submissionToken = data.details.token;
                    const expiresIn = data.details.duration;

                    outputDiv.textContent = `Token successfully received! Expires: ${expiresIn}\nToken: ${submissionToken.substring(0, 30)}...`;
                    
                    // Show Challenge fields
                    formFieldsDiv.classList.remove('hidden');
                    tokenStatusStrong.textContent = 'Token Ready';
                    tokenStatusStrong.style.color = 'var(--primary-neon)';
                    getTokenButton.disabled = true; // Prevent multiple token requests
                } else {
                    outputDiv.textContent = `Token Error: ${data.message || data.error}`;
                }
            } catch (error) {
                outputDiv.textContent = `Network Error during token request: ${error.message}`;
            }
        });

        // --- Step 2: Submit Challenge ---
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!submissionToken) {
                outputDiv.textContent = 'Error: Please get a submission token first.';
                return;
            }
            
            // Gather form data.
            const challengeText = document.getElementById('challengeText').value;
            const durationType = durationTypeSelect.value;
            const totalSessions = parseInt(document.getElementById('totalSessions').value);
            const cadence = (durationType === 'RECURRING' ? cadenceInput.value : undefined);

            const submissionData = {
                token: submissionToken,
                challengeText,
                totalSessions,
                durationType,
                cadence
            };
            
            outputDiv.textContent = 'Submitting challenge...';

            try {
                // FIX: Use the secure /submit/web endpoint
                const response = await fetch(`${API_BASE_URL}/user/submit/web`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(submissionData)
                });

                const data = await response.json();

                if (response.ok) {
                    outputDiv.textContent = `CHALLENGE SUBMITTED SUCCESSFULLY!\n\n${JSON.stringify(data, null, 2)}`;
                    form.reset();
                    // Reset UI for next submission
                    submissionToken = '';
                    formFieldsDiv.classList.add('hidden');
                    tokenStatusStrong.textContent = 'Awaiting Token';
                    tokenStatusStrong.style.color = 'var(--primary-neon)';
                    getTokenButton.disabled = false;
                } else {
                    outputDiv.textContent = `SUBMISSION FAILURE (${response.status}):\n${data.message || data.error}\n\n${JSON.stringify(data, null, 2)}`;
                }
            } catch (error) {
                outputDiv.textContent = `Network Error during submission: ${error.message}`;
            }
        });

        // Initialize cadence field visibility
        durationTypeSelect.dispatchEvent(new Event('change'));

    </script>
</body>
</html>