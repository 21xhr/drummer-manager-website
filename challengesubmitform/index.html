<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Challenge Submission Form</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="../styles.css">
</head>
<body class="dm-sans"> 
    <div class="form-container">
        <h1 class="dm-sans text-3xl font-bold text-center neon-text">
            New Challenge Submission
        </h1>
        <form id="challengeForm">
            <h2 class="form-heading">Authentication</h2>
            
            <div class="form-group">
                <label for="platformId">Your Platform Username:</label>
                <input type="text" id="platformId" class="form-input" placeholder="e.g., DrummerBoy21" required>
            </div>

            <div class="form-group">
                <label for="platformName">Streaming Platform:</label>
                <select id="platformName" class="form-input" required>
                    <option value="" disabled selected>Select Platform for Username</option>
                    <option value="KICK">üíö Kick</option>
                    <option value="TWITCH">üíú Twitch</option>
                    <option value="YOUTUBE">‚ù§Ô∏è YouTube</option>
                    </select>
            </div>

            <div class="form-group">
                <label for="duration">Token Duration (Optional):</label>
                <input type="text" id="duration" class="form-input" placeholder="This is totally optional">
            </div>

            <button type="button" id="getTokenButton" class="interactive-button form-button">
                Get Access Token
            </button>
    
            <div id="formFields" class="hidden">
                <h2 class="form-heading">Challenge Details</h2>
                <p class="roboto text-sm">
                    Access Status: <strong id="tokenStatus" style="color: var(--primary-neon);">Awaiting Token</strong>
                </p>
    
                <div class="form-group">
                    <label for="challengeText">Challenge Text:</label>
                    <textarea id="challengeText" class="form-input" placeholder="Describe the challenge." required></textarea>
                </div>
    
                <div class="form-group">
                    <label for="durationType">
                        Duration Type: 
                        <span class="info-tooltip-container">
                            ‚ìò
                            <span class="info-tooltip-text"> 
                                <strong>One-Off:</strong> Single 21-minute session.<br>
                                <strong>Recurring:</strong> Multiple 21-minute sessions over time.
                            </span>
                        </span>
                    </label>
                    <select id="durationType" class="form-input" required>
                        <option value="ONE_OFF">One-Off</option>
                        <option value="RECURRING">Recurring</option>
                    </select>
                </div>

                <div class="form-group" id="mainDurationGroup">
                    <label id="mainDurationLabel" for="totalTimeframeCount">Total Sessions:</label>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="number" id="totalTimeframeCount" class="form-input" min="1" value="1" max="999" style="width: 80px; margin-top: 0;" required>
                        <span id="totalTimeframeUnit" class="roboto" style="color: var(--text-color);">Sessions</span>
                    </div>
                </div>

                <div id="cadenceGroup" class="hidden">
                    <h3 class="roboto text-sm" style="margin-top: 1.5rem; color: var(--text-color); font-weight: bold;">
                        Define Challenge Cadence (Sessions are 21 minutes):
                    </h3>
                    
                    <div id="sentenceWrapper" style="display: flex; flex-direction: column; align-items: flex-start; gap: 8px; margin-top: 0.5rem;">
                        
                        <div id="primaryCadenceBlock" style="display: flex; flex-direction: column; align-items: flex-start; gap: 4px;">
                            
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span class="roboto">Suggest the Drummer do</span> 
                                <input type="number" id="cadenceCount" class="form-input" value="1" min="1" max="999" style="text-align: right; margin-top: 0; width: 60px !important;">
                                <span class="roboto">sessions</span>
                            </div>
                            
                            <select id="cadenceUnit" class="form-input" style="margin-top: 0;">
                                <option value="" class="hidden">select frequency</option>
                                <option value="DAILY">per Day</option>
                                <option value="WEEKLY">per Week</option>
                                <option value="MONTHLY">per Month</option>
                                <option value="CUSTOM_DAYS">every X days</option> 
                            </select>

                            <span id="customDaysGroup" class="hidden" style="display: flex; align-items: center; gap: 8px; margin-top: 4px;">
                                <span class="roboto">Every</span>
                                <input type="number" id="customDaysCount" class="form-input" value="3" min="2" max="365" style="width: 60px !important; text-align: right; margin-top: 0;">
                                <span class="roboto">days</span>
                            </span>
                        </div>


                        <span id="durationGroup" class="hidden" style="display: flex; align-items: center; gap: 8px;">
                            <span id="durationLeadInText" class="roboto">for a total of</span>
                            <input type="number" id="timeframeCountSentence" class="form-input" min="1" max="999" value="1" style="text-align: right; margin-top: 0; width: 60px !important;">
                            <span id="timeframeUnitSentence" class="roboto">Weeks</span>
                        </span>
                        
                    </div>

                    <div id="totalSummaryWrapper" style="margin-top: 0.5rem; margin-left: 0.5rem;">
                        <span class="roboto">Total:</span>
                        <strong id="cadencePreview" style="color: var(--primary-neon); margin-left: 5px;">1 Session (21 Mins)</strong>
                    </div>

                    <input type="hidden" id="sessionCadenceText">
                    <input type="hidden" id="calculatedTotalSessions" value="1">
                </div>
    
                <button type="submit" class="interactive-button form-button">
                    Submit Challenge
                </button>
                <h2 class="form-heading">Output</h2>
                <div id="output" class="roboto"></div>
            </div>
        </form>
    
    </div>

    <script>
    // --- CONFIG ---
    const SESSION_DURATION_MINUTES = 21;
    // --- API URL LOGIC (using local path for dev) ---
    const getApiBaseUrl = () => {
        const isNetworkIP = window.location.hostname.startsWith('192.168.1.'); 
        const isLocalhost = window.location.hostname === 'localhost' || 
                            window.location.hostname === '127.0.0.1';

        if (isNetworkIP) {
            return `http://${window.location.hostname}:3000/api/v1`;
        }
        if (isLocalhost) {
            return 'http://localhost:3000/api/v1'; 
        }
        return 'https://drummer-manager-api.vercel.app/api/v1';
    };
    const API_BASE_URL = getApiBaseUrl();

    // --- DOM REFERENCES ---
    const form = document.getElementById('challengeForm');
    const getTokenButton = document.getElementById('getTokenButton');
    const outputDiv = document.getElementById('output');
    const formFieldsDiv = document.getElementById('formFields');
    const tokenStatusStrong = document.getElementById('tokenStatus');
    const durationTypeSelect = document.getElementById('durationType');
    const submitButton = document.querySelector('button[type="submit"]'); 
    
    // MAIN DURATION FIELD
    const mainDurationGroup = document.getElementById('mainDurationGroup');
    const totalTimeframeCountInput = document.getElementById('totalTimeframeCount'); 
    
    // CADENCE SENTENCE ELEMENTS
    const cadenceGroup = document.getElementById('cadenceGroup');
    const cadenceUnitSelect = document.getElementById('cadenceUnit');
    const cadenceCountInput = document.getElementById('cadenceCount');
    const customDaysGroup = document.getElementById('customDaysGroup');
    const customDaysInput = document.getElementById('customDaysCount'); 
    const timeframeCountSentenceInput = document.getElementById('timeframeCountSentence');
    const timeframeUnitSentenceSpan = document.getElementById('timeframeUnitSentence');
    const cadencePreview = document.getElementById('cadencePreview');
    const sessionCadenceHidden = document.getElementById('sessionCadenceText');
    const calculatedTotalSessionsInput = document.getElementById('calculatedTotalSessions');
    const durationGroup = document.getElementById('durationGroup');
    const durationLeadInText = document.getElementById('durationLeadInText');

    let submissionToken = '';

    // --- Helper: Set Default Timeframe based on Cadence Unit (NEW) ---
    const setCadenceTimeframeDefaults = (unit) => {
        const currentFrameCount = parseInt(timeframeCountSentenceInput.value);
        const currentCadenceCount = parseInt(cadenceCountInput.value);
        
        if (unit === 'DAILY' || unit === 'CUSTOM_DAYS') {
            if (currentFrameCount <= 1) {
                timeframeCountSentenceInput.value = 2; 
            }
        } else if (unit === 'WEEKLY' || unit === 'MONTHLY') {
            if (currentFrameCount > 1) {
                timeframeCountSentenceInput.value = 1;
            }
        }
        
        if (unit === 'WEEKLY' || unit === 'MONTHLY') {
            if (currentCadenceCount <= 1) {
                cadenceCountInput.value = 2;
            }
            cadenceCountInput.min = 2; 
        } else if (unit === 'DAILY' || unit === 'CUSTOM_DAYS' || unit === "") {
            cadenceCountInput.min = 1;
            if (currentCadenceCount === 2) {
                cadenceCountInput.value = 1;
            }
        }
    };

    // --- Helper: Update the Cadence Sentence and Calculate Total Sessions (REVISED) ---
    const calculateTotalSessions = () => {
        const unit = cadenceUnitSelect.value;
        const pace = Math.min(parseInt(cadenceCountInput.value) || 1, 999);
        const customDays = parseInt(customDaysInput.value) || 1;
        const timeframeCount = Math.min(parseInt(timeframeCountSentenceInput.value) || 1, 999); 
        
        const minPace = parseInt(cadenceCountInput.min) || 1;
        const clampedPace = Math.max(pace, minPace);
        
        cadenceCountInput.value = clampedPace;
        timeframeCountSentenceInput.value = timeframeCount;

        let text = "";
        let calculatedTotal = 0;
        
        const isRecurring = durationTypeSelect.value === 'RECURRING';

        // --- 1. UI CONTROL: RESET ALL OPTIONS ---
        const options = cadenceUnitSelect.options;
        for (let i = 0; i < options.length; i++) {
            if (options[i].value === 'DAILY') options[i].textContent = "per Day";
            if (options[i].value === 'WEEKLY') options[i].textContent = "per Week";
            if (options[i].value === 'MONTHLY') options[i].textContent = "per Month";
            if (options[i].value === 'CUSTOM_DAYS') options[i].textContent = "every X days";
        }
        
        const selectFrequencyOption = cadenceUnitSelect.querySelector('option[value=""]');
        if (selectFrequencyOption) {
             selectFrequencyOption.classList.toggle('hidden', !!unit);
        }

        const isFrequencySelected = !!unit;
        
        durationGroup.classList.toggle('hidden', !isFrequencySelected);
        customDaysGroup.classList.add('hidden'); 
        
        // --- 2. COST CALCULATION & TEXT GENERATION ---
        
        let cadenceUnitText = "";
        let durationLeadIn = "for a total of"; 

        if (!isRecurring) {
            calculatedTotal = Math.min(parseInt(totalTimeframeCountInput.value) || 1, 999);
            totalTimeframeCountInput.value = calculatedTotal;
            text = `ONE_OFF: ${calculatedTotal} session(s).`;
            
        } else {
            
            if (unit === 'DAILY') {
                cadenceUnitText = "per Day";
                timeframeUnitSentenceSpan.textContent = "Days";
                calculatedTotal = clampedPace * timeframeCount;
                text = `${clampedPace} sessions per Day for ${timeframeCount} Days = ${calculatedTotal} Total Sessions`;
            } else if (unit === 'WEEKLY') {
                cadenceUnitText = "per Week";
                timeframeUnitSentenceSpan.textContent = "Weeks";
                calculatedTotal = clampedPace * timeframeCount;
                text = `${clampedPace} sessions per Week for ${timeframeCount} Weeks = ${calculatedTotal} Total Sessions`;
            } else if (unit === 'MONTHLY') {
                cadenceUnitText = "per Month";
                timeframeUnitSentenceSpan.textContent = "Months";
                calculatedTotal = clampedPace * timeframeCount;
                text = `${clampedPace} sessions per Month for ${timeframeCount} Months = ${calculatedTotal} Total Sessions`;
            } else if (unit === 'CUSTOM_DAYS') {
                cadenceUnitText = ""; 
                durationLeadIn = "then repeat this"; 
                
                customDaysGroup.classList.remove('hidden'); 
                timeframeUnitSentenceSpan.textContent = "times"; 
                calculatedTotal = clampedPace * timeframeCount;
                
                text = `${clampedPace} sessions every ${customDays} days for ${timeframeCount} times = ${calculatedTotal} Total Sessions`;
            } else {
                cadenceUnitText = "select frequency";
                timeframeUnitSentenceSpan.textContent = "..."; 
                text = "Select a frequency and duration to calculate total sessions.";
                calculatedTotal = 0;
            }

            const selectedOption = cadenceUnitSelect.querySelector(`option[value="${unit}"]`);
            if (selectedOption) {
                selectedOption.textContent = cadenceUnitText;
            }
            
            durationLeadInText.textContent = durationLeadIn;
        }
        
        const totalMinutes = calculatedTotal * SESSION_DURATION_MINUTES;

        calculatedTotalSessionsInput.value = calculatedTotal;
        cadencePreview.textContent = `${calculatedTotal} Sessions (${totalMinutes} Mins)`;
        sessionCadenceHidden.value = text;
    };


    // --- UX IMPROVEMENT: Generate Human-Readable Challenge Summary (MODIFIED) ---
    // Now accepts the new userStats object
    const generateChallengeSummary = (challenge, cost, userStats) => {
        if (!challenge) return `<p class="roboto" style="color: red;">Error: Challenge data is missing from the API response.</p>`;

        const isRecurring = challenge.durationType === 'RECURRING';
        let cadenceInfo = '';
        
        if (isRecurring) {
            const cadenceDescription = challenge.sessionCadenceText || "Cadence defined by the proposer."; 
            cadenceInfo = `
                <p class="roboto" style="margin-top: 5px;">
                    <strong>Cadence:</strong> ${cadenceDescription}
                </p>
            `;
        }

        // --- NEW: User Stats Summary Block ---
        let statsInfo = '';
        if (userStats) {
            statsInfo = `
                <div style="margin-top: 20px; padding: 10px; border: 1px dashed var(--primary-neon); background-color: rgba(138, 43, 226, 0.1);">
                    <h4 class="roboto" style="margin-top: 0; font-weight: bold; color: var(--primary-neon);">Your Updated Stats:</h4>
                    <p class="roboto" style="margin: 5px 0;">
                        <strong>New Balance:</strong> ${userStats.lastKnownBalance} NUMBERS
                    </p>
                    <p class="roboto" style="margin: 5px 0;">
                        <strong>Daily Submissions:</strong> ${userStats.dailySubmissionCount} (Resets daily)
                    </p>
                    <p class="roboto" style="margin: 5px 0;">
                        <strong>Total Challenges Proposed:</strong> ${userStats.totalChallengesSubmitted}
                    </p>
                    <p class="roboto" style="margin: 5px 0;">
                        <strong>Total Spent Game-Wide:</strong> ${userStats.totalNumbersSpent} NUMBERS
                    </p>
                </div>
            `;
        }


        return `
            <h3 class="form-heading" style="margin-top: 0; border-bottom: none; color: var(--success-green); text-shadow: 0 0 5px rgba(0, 255, 0, 0.5);">
                ‚úÖ Challenge Submitted Successfully!
            </h3>
            <hr style="border-top: 1px solid var(--primary-neon); margin: 15px 0;">

            <h4 class="roboto" style="margin-top: 0; font-weight: bold; color: var(--primary-neon);">Challenge Details:</h4>
            <p class="roboto">
                <strong>Cost:</strong> ${cost} NUMBERS
            </p>
            <p class="roboto">
                <strong>Challenge ID:</strong> #${challenge.challengeId}
            </p>
            <p class="roboto">
                <strong>Duration Type:</strong> ${challenge.durationType}
            </p>
            <p class="roboto">
                <strong>Total Sessions:</strong> ${challenge.totalSessions} sessions (${challenge.totalSessions * SESSION_DURATION_MINUTES} Mins total)
            </p>
            ${cadenceInfo}

            <div style="margin-top: 15px; padding: 10px; border: 1px dashed var(--primary-neon);">
                <strong>Challenge Text:</strong><br>
                <span style="font-style: italic;">"${challenge.challengeText}"</span>
            </div>

            ${statsInfo} 
            
            <p class="roboto" style="margin-top: 20px; font-size: 0.9rem;">
                You can now close this window or refresh the page to submit a new challenge.
            </p>
        `;
    };


    // --- Event Listeners ---
    cadenceUnitSelect.addEventListener('change', (e) => {
        setCadenceTimeframeDefaults(e.target.value); 
        calculateTotalSessions();
    });
    cadenceCountInput.addEventListener('input', calculateTotalSessions);
    customDaysInput.addEventListener('input', calculateTotalSessions);
    timeframeCountSentenceInput.addEventListener('input', calculateTotalSessions); 
    totalTimeframeCountInput.addEventListener('input', calculateTotalSessions);

    // --- UI Logic for Duration Type ---
    durationTypeSelect.addEventListener('change', (e) => {
        const isRecurring = e.target.value === 'RECURRING';
        cadenceGroup.classList.toggle('hidden', !isRecurring);
        mainDurationGroup.classList.toggle('hidden', isRecurring);
        
        cadenceUnitSelect.required = isRecurring;
        
        if (isRecurring) {
            if (cadenceUnitSelect.value) {
                setCadenceTimeframeDefaults(cadenceUnitSelect.value);
            }
        }
        calculateTotalSessions(); 
    });
    
    // Add dynamic CSS rules
    const styleSheet = document.styleSheets[0];
    try {
        styleSheet.insertRule(':root { --success-green: #39FF14; }', styleSheet.cssRules.length);
        styleSheet.insertRule('.form-input--disabled { background-color: #2c2c2c !important; border-color: #444 !important; color: #888 !important; cursor: not-allowed; }', styleSheet.cssRules.length);
    } catch (e) {
        console.warn("Could not insert CSS rules.");
    }

    // --- Step 1: Get Token ---
    getTokenButton.addEventListener('click', async () => { 
        const platformId = document.getElementById('platformId').value;
        const platformName = document.getElementById('platformName').value;
        const duration = document.getElementById('duration').value || undefined; 

        if (!platformId || !platformName) {
            outputDiv.textContent = 'Error: Platform Username and Platform are required.';
            return;
        }
        outputDiv.textContent = 'Requesting token...';

        try {
            const response = await fetch(`${API_BASE_URL}/token/submit-challenge`, { 
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ platformId, platformName, duration })
            });

            const data = await response.json();

            if (response.ok) {
                submissionToken = data.details.token;
                const expiresIn = data.details.duration;
                outputDiv.textContent = `Token successfully received! Expires: ${expiresIn}`;
                formFieldsDiv.classList.remove('hidden');
                tokenStatusStrong.textContent = 'Ready'; 
                tokenStatusStrong.style.color = 'var(--primary-neon)';
                getTokenButton.disabled = true; 
            } else {
                outputDiv.textContent = `Token Error: ${data.message || data.error}`;
            }
        } catch (error) {
            outputDiv.textContent = `NETWORK OR FRONT-END ERROR: ${error.message}`;
        }
    });


    // --- Step 2: Submit Challenge ---
    form.addEventListener('submit', async (e) => { 
        e.preventDefault();
        if (!submissionToken) { 
            outputDiv.textContent = 'Error: Please get an access token first.';
            return; 
        }
        
        submitButton.disabled = true;
        
        const challengeText = document.getElementById('challengeText').value;
        const durationType = durationTypeSelect.value;
        
        const totalSessions = durationType === 'RECURRING' 
            ? parseInt(calculatedTotalSessionsInput.value) 
            : parseInt(totalTimeframeCountInput.value); 

        const cadenceUnit = (durationType === 'RECURRING' ? cadenceUnitSelect.value : undefined);
        const sessionCadenceText = (durationType === 'RECURRING' ? sessionCadenceHidden.value : undefined);

        const submissionData = {
            token: submissionToken,
            challengeText,
            totalSessions,
            durationType,
            cadenceUnit,
            sessionCadenceText
        };
        
        outputDiv.textContent = 'Submitting challenge...';

        try {
            const response = await fetch(`${API_BASE_URL}/user/submit/web`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(submissionData)
            });

            const data = await response.json();

            if (response.ok) {
                // ‚≠ê CRITICAL FIX: Robustly extract payload data by checking common API wrappers.
                const payload = data.details || data.data || data; 

                const challengeData = payload.newChallenge;
                const cost = payload.cost;
                // ‚≠ê NEW: Extract the userStats object
                const userStats = payload.userStats; 
                
                if (!challengeData || typeof cost !== 'number' || !userStats) {
                    // Fail gracefully if response is ok but data structure is bad
                    outputDiv.textContent = `SUBMISSION ERROR: API returned success but payload was malformed (Missing Challenge or User Stats). Check the browser console for raw response details.`;
                    console.error("Malformed API submission response:", data);
                    submitButton.disabled = false;
                    return; 
                }

                // ‚≠ê UX FIX: Pass the new userStats to the summary function
                outputDiv.innerHTML = generateChallengeSummary(challengeData, cost, userStats);
                
                // Keep the form fields visible but disable the form controls to signal completion
                Array.from(form.elements).forEach(element => {
                    if (element.id !== 'output' && element.id !== 'getTokenButton') {
                        element.disabled = true;
                        element.classList.add('form-input--disabled');
                    }
                });
                submitButton.style.display = 'none'; // Hide the submit button
                
            } else {
                // Handle submission failure
                outputDiv.textContent = `SUBMISSION FAILURE (${response.status}):\n${data.message || data.error}`;
                submitButton.disabled = false; // Re-enable submit button on error
            }
        } catch (error) {
            outputDiv.textContent = `NETWORK OR FRONT-END ERROR: ${error.message}`;
            submitButton.disabled = false; // Re-enable submit button on network error
        }
    });

    // Initialize display and calculation
    durationTypeSelect.dispatchEvent(new Event('change'));
</script>
</body>
</html>