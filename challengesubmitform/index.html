<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Challenge Submission Form</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="../styles.css"> 
</head>
<body class="dm-sans"> 
    <div class="form-container">
        <h1 class="dm-sans text-3xl font-bold text-center neon-text">
            New Challenge Submission
        </h1>
        <p class="roboto text-center text-sm text-gray-400">
            This form simulates the secure, two-step challenge submission process.
        </p>
    
        <form id="challengeForm">
            <h2 class="form-heading">1. User Authentication (Step 1: Get Token)</h2>
            
            <div class="form-group">
                <label for="platformId">Platform ID (Your Username):</label>
                <input type="text" id="platformId" class="form-input" placeholder="e.g., DrummerBoy21" required>
            </div>

            <div class="form-group">
                <label for="platformName">Platform Name:</label>
                <select id="platformName" class="form-input" required>
                    <option value="" disabled selected>The Streaming Platform You Came From</option>
                    <option value="KICK">Kick</option>
                    <option value="TWITCH">Twitch</option>
                    <option value="YOUTUBE">Youtube</option>
                    </select>
            </div>

            <div class="form-group">
                <label for="duration">Token Duration (Optional):</label>
                <input type="text" id="duration" class="form-input" placeholder="This is totally optional">
            </div>

            <button type="button" id="getTokenButton" class="interactive-button form-button">
                Get Submission Token
            </button>
    
            <div id="formFields" class="hidden">
                <h2 class="form-heading">2. Challenge Details (Step 2: Submit)</h2>
                <p class="roboto text-sm">
                    Token Status: <strong id="tokenStatus" style="color: var(--primary-neon);">Awaiting Token</strong>
                </p>
    
                <div class="form-group">
                    <label for="challengeText">Challenge Text:</label>
                    <textarea id="challengeText" class="form-input" placeholder="Briefly describe the challenge (e.g., Play a fill using only triplets, Do a solo with one hand tied)." required></textarea>
                </div>
    
                <div class="form-group">
                    <label for="durationType">Duration Type:</label>
                    <select id="durationType" class="form-input" required>
                        <option value="ONE_OFF">ONE_OFF (Single Session)</option>
                        <option value="RECURRING">RECURRING (Multiple Sessions)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="totalSessions">Total Sessions (Min 1):</label>
                    <input type="number" id="totalSessions" class="form-input" min="1" value="7" required>
                </div>
                
                <div id="cadenceGroup" class="hidden">
                    <div class="form-group">
                        <label for="cadenceUnit">Cadence Frequency:</label>
                        <select id="cadenceUnit" class="form-input">
                            <option value="" disabled selected>Select Frequency</option>
                            <option value="DAILY">Daily</option>
                            <option value="WEEKLY">Weekly</option>
                            <option value="MONTHLY">Monthly</option>
                            <option value="CUSTOM_DAYS">Custom (Every X Days)</option>
                        </select>
                    </div>

                    <div class="form-group" style="margin-top: 15px;">
                        <label id="cadenceLabel" for="cadenceCount">Pace:</label>
                        
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="number" id="cadenceCount" class="form-input" value="1" min="1" style="width: 80px; margin-top: 0;">
                            <span id="cadenceSuffix" class="roboto" style="color: var(--text-color);">sessions per day</span>
                        </div>
                    </div>

                    <div id="customDaysGroup" class="hidden form-group" style="margin-top: 10px;">
                        <label for="customDaysCount">Every how many days?</label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span class="roboto">Every</span>
                            <input type="number" id="customDaysCount" class="form-input" value="3" min="2" style="width: 80px; margin-top: 0;">
                            <span class="roboto">days</span>
                        </div>
                    </div>

                    <input type="hidden" id="sessionCadenceText">
                    
                    <p class="roboto text-sm" style="margin-top: 10px; color: gray;">
                        Summary: <strong id="cadencePreview" style="color: var(--primary-neon);">...</strong>
                    </p>
                </div>
    
                <button type="submit" class="interactive-button form-button">
                    Submit Challenge
                </button>
            </div>
        </form>
    
        <h2 class="form-heading">Output</h2>
        <div id="output" class="roboto"></div>
    </div>

    <script>
        const getApiBaseUrl = () => {
            const isNetworkIP = window.location.hostname.startsWith('192.168.1.'); 
            const isLocalhost = window.location.hostname === 'localhost' || 
                                window.location.hostname === '127.0.0.1';

            if (isNetworkIP) {
                // ⭐ FIX: If accessed via network IP (like 192.168.1.37), use that IP
                // to call the API on port 3000.
                return `http://${window.location.hostname}:3000/api/v1`;
            }
            
            if (isLocalhost) {
                // If accessed via localhost, use localhost (for safety and simplicity)
                return 'http://localhost:3000/api/v1'; 
            }
            
            // Production/Vercel URL
            return 'https://drummer-manager-api.vercel.app/api/v1';
        };
        const API_BASE_URL = getApiBaseUrl();

        const form = document.getElementById('challengeForm');
        const getTokenButton = document.getElementById('getTokenButton');
        const outputDiv = document.getElementById('output');
        const formFieldsDiv = document.getElementById('formFields');
        const tokenStatusStrong = document.getElementById('tokenStatus');
        const durationTypeSelect = document.getElementById('durationType');
        
        // ⭐ CADENCE ELEMENTS
        const cadenceGroup = document.getElementById('cadenceGroup');
        const cadenceUnitSelect = document.getElementById('cadenceUnit');
        const cadenceCountInput = document.getElementById('cadenceCount'); 
        const cadenceSuffix = document.getElementById('cadenceSuffix'); 
        const customDaysGroup = document.getElementById('customDaysGroup');
        const customDaysInput = document.getElementById('customDaysCount'); 
        const cadencePreview = document.getElementById('cadencePreview');
        const sessionCadenceHidden = document.getElementById('sessionCadenceText');

        let submissionToken = '';

        // --- Helper: Update the Cadence Sentence ---
        const updateCadenceUi = () => {
            const unit = cadenceUnitSelect.value;
            const count = cadenceCountInput.value;
            const customDays = customDaysInput.value;
            let text = "";

            if (unit === 'DAILY') {
                cadenceSuffix.textContent = "sessions per Day";
                customDaysGroup.classList.add('hidden');
                text = `${count} sessions per Day`;
            } else if (unit === 'WEEKLY') {
                cadenceSuffix.textContent = "sessions per Week";
                customDaysGroup.classList.add('hidden');
                text = `${count} sessions per Week`;
            } else if (unit === 'MONTHLY') {
                cadenceSuffix.textContent = "sessions per Month";
                customDaysGroup.classList.add('hidden');
                text = `${count} sessions per Month`;
            } else if (unit === 'CUSTOM_DAYS') {
                cadenceSuffix.textContent = "sessions...";
                customDaysGroup.classList.remove('hidden');
                text = `${count} sessions every ${customDays} days`;
            } else {
                cadenceSuffix.textContent = "...";
                text = "Please select a frequency";
            }

            cadencePreview.textContent = text;
            sessionCadenceHidden.value = text;
        };

        // --- Event Listeners ---
        cadenceUnitSelect.addEventListener('change', updateCadenceUi);
        cadenceCountInput.addEventListener('input', updateCadenceUi);
        customDaysInput.addEventListener('input', updateCadenceUi);

        // --- UI Logic for Duration Type ---
        durationTypeSelect.addEventListener('change', (e) => {
            const isRecurring = e.target.value === 'RECURRING';
            cadenceGroup.classList.toggle('hidden', !isRecurring);
            cadenceUnitSelect.required = isRecurring;
            if(isRecurring) updateCadenceUi(); 
        });

        // --- Step 1: Get Token ---
        getTokenButton.addEventListener('click', async () => {
            const platformId = document.getElementById('platformId').value;
            const platformName = document.getElementById('platformName').value;
            const duration = document.getElementById('duration').value || undefined; 

            if (!platformId || !platformName) {
                outputDiv.textContent = 'Error: Platform ID and Name are required.';
                return;
            }
            outputDiv.textContent = 'Requesting token...';

            try {
                const response = await fetch(`${API_BASE_URL}/token/submit-challenge`, { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ platformId, platformName, duration })
                });

                const data = await response.json();

                if (response.ok) {
                    submissionToken = data.details.token;
                    const expiresIn = data.details.duration;
                    outputDiv.textContent = `Token successfully received! Expires: ${expiresIn}\nToken: ${submissionToken.substring(0, 30)}...`;
                    formFieldsDiv.classList.remove('hidden');
                    tokenStatusStrong.textContent = 'Token Ready';
                    tokenStatusStrong.style.color = 'var(--primary-neon)';
                    getTokenButton.disabled = true; 
                } else {
                    outputDiv.textContent = `Token Error: ${data.message || data.error}`;
                }
            } catch (error) {
                outputDiv.textContent = `Network Error: ${error.message}`;
            }
        });

        // --- Step 2: Submit Challenge ---
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!submissionToken) { return; }
            
            const challengeText = document.getElementById('challengeText').value;
            const durationType = durationTypeSelect.value;
            const totalSessions = parseInt(document.getElementById('totalSessions').value);

            // ⭐ EXTRACT CADENCE DATA
            const cadenceUnit = (durationType === 'RECURRING' ? cadenceUnitSelect.value : undefined);
            const sessionCadenceText = (durationType === 'RECURRING' ? sessionCadenceHidden.value : undefined);

            const submissionData = {
                token: submissionToken,
                challengeText,
                totalSessions,
                durationType,
                cadenceUnit,
                sessionCadenceText
            };
            
            outputDiv.textContent = 'Submitting challenge...';

            try {
                const response = await fetch(`${API_BASE_URL}/user/submit/web`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(submissionData)
                });

                const data = await response.json();

                if (response.ok) {
                    outputDiv.textContent = `CHALLENGE SUBMITTED SUCCESSFULLY!\n\n${JSON.stringify(data, null, 2)}`;
                    form.reset();
                    submissionToken = '';
                    formFieldsDiv.classList.add('hidden');
                    tokenStatusStrong.textContent = 'Awaiting Token';
                    tokenStatusStrong.style.color = 'var(--primary-neon)';
                    getTokenButton.disabled = false;
                    if (durationTypeSelect.value !== 'RECURRING') cadenceGroup.classList.add('hidden');
                } else {
                    outputDiv.textContent = `SUBMISSION FAILURE (${response.status}):\n${data.message || data.error}\n\n${JSON.stringify(data, null, 2)}`;
                }
            } catch (error) {
                outputDiv.textContent = `Network Error: ${error.message}`;
            }
        });

        durationTypeSelect.dispatchEvent(new Event('change'));
    </script>
</body>
</html>